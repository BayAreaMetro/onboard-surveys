---
title: "Apply Chi-Squared Test"
author: "David Ory"
output: 
   html_document:
      theme: cosmo
      toc: yes
---

## Administration

#### Purpose
This script consumes prior and observed estimates of boarding and alighting pattern by route, direction, time-of-day, boarding segment, and alighting segment and then compares them via the chi-squared test.  The first set of prior estimates are the result of a data munging exercise using automated passenger count data and travel model data -- see `muni-travel-model-priors.Rmd`.  The observed estimates come from an on-to-off transit on-board survey. If the on-board survey proceeds iteratively, the priors can be updated with observed data and then be compared to subsequently collected observed data.

The current implementation uses example data. 

#### Outputs
1.  A database of chi-squared test results

#### _TODO_ 
1.  Bones in place
2.  Need to debug this: specifically start with 44 and make sure sequence numbers are logical
3.  Add a check to toss an error if the sequence is off, e.g., a flow from B to A.
4.  Get this working for a few more routes and then make more general

## Procedure

#### Overhead
```{r overhead, results = 'hide'}
library(knitr)
suppressMessages(library(dplyr))
```

```{r config, include=FALSE}
knitr::opts_chunk$set(cache=TRUE)
```

#### Paramaters
```{r parameters}
obs_time_of_day = c("AM PEAK", "MIDDAY",  "SCHOOL",   "PM PEAK")
time_of_day     = c("AM",      "MD",      "MD",       "PM")
time_of_day_df <- data.frame(obs_time_of_day, time_of_day, stringsAsFactors = FALSE)

# FIX ME
# so, the forward is easy
# the backwards, perhaps for now introduce another variable for the max segment
# if the max is 3, then the 3,2,1 corresponds to A,B,C
# if the max is 2, then the 2,1 corresponds to A,B
# then make this more elegant, programmatic as more data comes in
# perhaps just make this a separate database?

segment_number = c(1,2,3,4,5,
                   5,4,3,2,1,
                   4,3,2,1,
                   3,2,1,
                   2,1)
segment_letter = c("A","B","C","D","E",
                   "A","B","C","D","E",
                   "A","B","C","D",
                   "A","B","C",
                   "A","B")
segment_enum   = c("forward",  "forward",  "forward",  "forward",  "forward",
                   "backward", "backward", "backward", "backward", "backward",
                   "backward", "backward", "backward", "backward",
                   "backward", "backward", "backward",
                   "backward", "backward")
max_segment    = c(0,0,0,0,0,
                   5,5,5,5,5,
                   4,4,4,4,
                   3,3,3,
                   2,2)
number_to_letter <- data.frame(segment_number, segment_letter, segment_enum, max_segment, stringsAsFactors = FALSE)

obs_route_name = c("9-San Bruno [ OUTBOUND ]",     "9-San Bruno [ INBOUND ]",
                   "44-O Shaughnessy [ OUTBOUND ]", "44-O Shaughnessy [ INBOUND ]")

route          = c("9","9","44","44")
direction      = c("OUTBOUND","INBOUND","OUTBOUND","INBOUND")
segment_enum   = c("forward","backward","backward","backward")
max_segment    = c(0,3,4,4)
route_names <- data.frame(obs_route_name, route, direction, segment_enum, max_segment, stringsAsFactors = FALSE)

```

#### Remote I/O Locations
```{r remote-io}
F_PRIOR_FLOWS    = "M:/Data/OnBoard/Data and Reports/Muni/travel-model-priors/priors.csv"

F_OBSERVED_FLOWS_09 = "M:/Data/OnBoard/Data and Reports/Muni/On-to-Off/As CSV/MUNI_ON2OFF_DRAFT-FINAL_SUBMITTAL1_20160408_910.csv"

F_OBSERVED_FLOWS_44 = "M:/Data/OnBoard/Data and Reports/Muni/On-to-Off/As CSV/MUNI_ON2OFF_DRAFT-FINAL_SUBMITTAL1_20160408_4416.csv"

F_OUTPUT = "M:/Data/OnBoard/Data and Reports/Muni/On-to-Off/chi-squared-results.csv"
```

#### Data reads
```{r data-reads}
priors_df <-   read.table(file = F_PRIOR_FLOWS,    header = TRUE, sep = ",", stringsAsFactors = FALSE)

observed_09 <- read.table(file = F_OBSERVED_FLOWS_09, header = TRUE, sep = ",", stringsAsFactors = FALSE)

observed_44 <- read.table(file = F_OBSERVED_FLOWS_44, header = TRUE, sep = ",", stringsAsFactors = FALSE)

observed_df <- rbind(observed_09, observed_44)

```

#### Data cleans
```{r data-cleans}
# Observed

# Clean up the time periods
observed_clean <- observed_df %>%
  rename(obs_time_of_day = TIME.PERIOD) %>%
  rename(obs_route_name  = ROUTE_DESCRIPTION)

observed_clean <- left_join(observed_clean, time_of_day_df, by = c("obs_time_of_day"))

# Look up the route, direction, alignment with sequence numbers
observed_clean <- left_join(observed_clean, route_names, by = c("obs_route_name"))

# Convert the boarding segments to letters
observed_clean <- observed_clean %>%
  mutate(segment_number = SEGMENT_ON)

observed_clean <- left_join(observed_clean, number_to_letter, by = c("segment_number","segment_enum", "max_segment"))

# Convert the alighting segments to letters
observed_clean <- observed_clean %>%
  rename(board_segment = segment_letter) %>%
  mutate(segment_number = SEGMENT_OFF)

observed_clean <- left_join(observed_clean, number_to_letter, by = c("segment_number", "segment_enum", "max_segment"))

observed_clean <- observed_clean %>%
  rename(alight_segment = segment_letter) %>%
  select(-max_segment)

# Get the variables I want and sum
observed_clean <- observed_clean %>%
  select(ETC_ID, route, direction, time_of_day, board_segment, alight_segment, segment_enum)

observed_sum <- observed_clean %>%
  group_by(route, direction, time_of_day, board_segment, alight_segment) %>%
  summarise(observed_flow = n())

observed_daily <- observed_clean %>%
  group_by(route, direction, board_segment, alight_segment) %>%
  summarise(observed_flow = n()) %>%
  ungroup() %>%
  mutate(time_of_day = "daily")

observed_sum <- rbind(observed_sum, observed_daily)

# Priors
priors_clean <- priors_df %>%
  select(route, direction, time_of_day, board_segment, alight_segment, prior_flow = flow)

```


#### Data joins
```{r data-joins}
# Remove observed for non-relevant time periods
observed_join <- observed_sum %>%
  filter(is.na(time_of_day) == FALSE)

joined_df <- left_join(observed_join, priors_clean, by = c("route", "direction", "time_of_day", "board_segment", "alight_segment"))

# Fill in missing priors with 1
joined_df <- joined_df %>%
  mutate(prior_flow = ifelse(is.na(prior_flow), 1, prior_flow))

```

#### Chi-squared tests
```{r chi-squared-tests}
# use dplyr
outcome_df <- joined_df %>%
  group_by(route, direction, time_of_day) %>%
  summarise(test_statistic = chisq.test(observed_flow, p = prior_flow/sum(prior_flow))$statistic[["X-squared"]],
            test_df        = chisq.test(observed_flow, p = prior_flow/sum(prior_flow))$parameter[["df"]],
            test_p_value   = chisq.test(observed_flow, p = prior_flow/sum(prior_flow))$p.value)

```

#### Data write
```{r data-write}
write.csv(outcome_df, file = F_OUTPUT, row.names = FALSE, quote = F)

```

