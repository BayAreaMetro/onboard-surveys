---
title: "Muni Travel Model Priors"
author: "David Ory"
output: 
   html_document:
      theme: cosmo
      toc: yes
---

## Administration

#### Purpose
This script consumes boarding and alighting data from SF Muni automated passenger counters, boarding and alighting flows from the SFCTA SF-CHAMP travel model, route segment definitions provided by SF Muni, and a crosswalk connecting the APC and travel model data.  It combines this data to generate an estimate of boarding and alighting flows consistent with both the APC and travel model data for potenital use as prior estimates of flows on SF Muni.  

#### Outputs
1.  A consolidated database of flow estimates

#### _TODO_
1.  Everything, early days

## Procedure

#### Overhead
```{r overhead, results = 'hide'}
library(knitr)
library(reshape2)
suppressMessages(library(dplyr))
library(stringr)
```

```{r config, include=FALSE}
knitr::opts_chunk$set(cache=TRUE)
```

#### Remote I/O Locations
```{r remote-io}
F_APC = "M:/Data/Transit/Muni APC Through Time/consolidated-database.csv"
F_RAIL_DUMMY_APC = ""
F_CHAMP = ""
F_CROSSWALK = ""
F_SEGMENTS = ""
F_OUTPUT = ""
```


# Rough outline of steps
1.  Get the segment data from Shimon/Alex
1.  Build the crosswalk which has an entry for each: Muni APC key and APC sequence number.  It then has multiple entries for CHAMP key and CHAMP sequence number.  Do this for five big lines first.
1.  Create dummy entries in the APC data for the light rail lines using the CHAMP output.  Then add these lines to the dummy cross walk.
1.  Create a segment data base from the segment spreadsheet.  It has APC key, APC sequence number, and segment letter (e.g., A, B, C, ...). 
1.  Read in all of the data.
1.  Start with one line for one time of day.
1.  Join the APC data with the segment database to get the segment letter for each stop.
1.  Join the CHAMP data to the crosswalk and the segment database to get the boarding and alighting segment letter
1.  So, for each line, direction, and time-of-day, we'll summarize the CHAMP data to get flows by boarding segment and alighting segment.  Then we'll summarize APC to get boardings by segment and, separately, alighting by segment.
1.  The APC sums are my marginals.  The CHAMP sums are my seed.  Try the log-linear approach.  See loglin-reference chunk.  Data frame to matrices reference: http://stackoverflow.com/questions/5158790/data-frame-or-matrix
1.  Once you get it for one, create a function and loop by time-of-day and route.
1.  Write out in a logical database.  Something like: APC name, direction, time-of-day, boarding segment, alighting segment, estimated flow.

```{r loglin-reference}
mat <- matrix(c(65,4,22,24,6,81,5,8,0,11,85,19,4,7,3,90),4,4)

rowmarg <- rep(100, nrow(mat))  # the row margin totals that you want

colmarg <- c(90, 120, 80, 110)  # the column margin totals that you want

newmat <- loglin( outer(rowmarg, colmarg) / sum(rowmarg), margin=list(1,2),
start=mat, fit=TRUE, eps=1.e-05, iter=100)$fit

newmat

apply(newmat, 1, sum)

apply(newmat, 2, sum)



```

