---
title: "Tri-Delta On Off Exploration"
author: "David Ory"
date: "Monday, August 11, 2014"
html_document:
    toc: true
    theme: cosmo
runtime: shiny
---

## Administration

## Status
2014 08 06 dto: very early days

## Purpose
A key question for the transit on-board survey is whether or not there is value in performing an on/off pre-survey for small operators.  To help answer this question, we collected deep on/off sample (approximately 70 percent of all ons and offs) for the Tri-Delta system.  What we want to know is (a) is it possible to craft logical weights based on boarding-alighting patterns for low ridership systems and, (b) if so, when and where and for whom would expansion weights based on route + direction + time of day be meaningfully different than weights based on route + time-of-day + direction + boarding-alighting?  

## Outputs
1.  `TODO` In-line charts and ugly tables

## TODO
1. Everything

## Procedure
```{r}
library(knitr)
suppressMessages(library(dplyr))
library(stringr)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=TRUE)
```

### Data reads
```{r data_reads}
input.tablet <- read.table(file = "M:/Data/OnBoard/Data and Reports/Tri Delta/As CSV/ONBOARD NO POUND OR SINGLE QUOTE.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)

input.onoff  <- read.table(file = "M:/Data/OnBoard/Data and Reports/Tri Delta/As CSV/ON2OFF NO POUND OR SINGLE QUOTE.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)
```

## Peek around
```{r peek-around}
tablet <- input.tablet %>%
  select(tablet_id = ID, route_dir = ROUTE.CODE, direction = DIRECTION, time_period = TIME_PERIOD, board_id = BOARDING_LOCATION_STOPID, BOARDING_LOCATION_STOPID_SHP, alight_id = ALIGHTING_LOCATION_STOPID, ALIGHTING_LOCATION_STOPID_SHP, weight = UNLINKED_WGHT_FCTR)

onoff <- input.onoff %>%
  select(onoff_id = ETC_ID, ROUTE_ON, DIRECTION_ON, ROUTE_OFF, DIRECTION_OFF, time_period = TIME.PERIOD, board_id = BOARDING_STOPID_, BOARDING_STOPID_SHP, board_seq = BOARDING_STOPSEQUENCE, alight_id = ALIGHTING_STOPID_, ALIGHTING_STOPID_SHP, alight_seq = ALIGHTING_STOPSEQUENCE, MATCH_CONFIDENCE = matchConfidence)

# Join by route, direction, time of day, board, alight
tablet <- tablet %>%
  mutate(route = as.numeric(str_sub(route_dir, 1, 3))) %>%
  mutate(board_id = as.numeric(board_id)) %>%
  mutate(alight_id = as.numeric(alight_id)) %>%
  mutate(time_period = ifelse(time_period == "LATE PM", "EVENING", time_period))

onoff <- onoff %>%
  mutate(route = ROUTE_ON) %>%
  mutate(direction = DIRECTION_ON) %>%
  mutate(time_period = ifelse(time_period == "AM1", "EARLY AM", time_period)) %>%
  mutate(time_period = ifelse(time_period == "AM2", "AM PEAK",  time_period)) %>%
  mutate(time_period = ifelse(time_period == "MID", "MIDDAY",   time_period)) %>%
  mutate(time_period = ifelse(time_period == "PM1", "PM PEAK",  time_period)) %>%
  mutate(time_period = ifelse(time_period == "PM2", "EVENING",  time_period))

onoff_sum <- onoff %>%
  group_by(route, direction, time_period, board_id, alight_id) %>%
  summarise(onoff_count = n())

tab_onoff <- left_join(tablet, onoff_sum, by = c("route", "direction", "time_period", "board_id", "alight_id"))

tab_onoff <- tab_onoff %>%
  mutate(onoff_count = ifelse(is.na(onoff_count), 0, onoff_count))

table(tab_onoff$onoff_count)

# START HERE: join by route, then route + dir, then add time of day, see how well you match as you go, building up to full match, figure out what's going on.

```

