---
title: "Production"
author: "David Ory"
output:
  html_document:
    theme: cosmo
    toc: yes
runtime: shiny
---

## Administration

#### Purpose
Procedure to translate any number of on-board survey data sets into a single dataset with common variables and common responses.  This is a work-in-progress production version of the procedures.  See ``../mini-example`` and ``../small-example`` for working proto-types.

#### _ISSUES_
1.  Check a few freqs comparing the input data and the derived flat file
2.  Handle Redhill follow up an trip purpose

#### _TODO_
1.  Get all the data read in and overhead established
2.  Extract Sriram's variables (workers, variables, hh size) for all of the datasets
3.  Then go to the latest Redhill and latest ETC -- build full generalization
4.  Add standard processing steps once data is in place
5.  Interim solution -- build generic, process generic, add generic to SAS files (via CSV and R), extract any new variables from generic
6.  Add Tableau extracts
7.  Operator-by-operator, re-factor SAS workflow
8.  Add data types before exporting to RData


## Overhead

#### Libraries
```{r overhead}
library(knitr)
library(reshape2)
suppressMessages(library(dplyr))
library(stringr)
```

#### Knitr config
```{r config, include=FALSE}
knitr::opts_chunk$set(cache=TRUE)
```

## Prepare Dictionaries
```{r prepare-dictionary}
dictionary.all <- read.csv('Dictionary.csv', header = TRUE)

# Prepare seperate dictionaries for categorical and non-categorical variables
dictionary.non <- dictionary.all %.%
  filter(Generic_Response == 'NONCATEGORICAL') %.%
  select(Operator, Survey_Variable, Generic_Variable)

dictionary.cat <- dictionary.all %.%
  filter(Generic_Response != 'NONCATEGORICAL') %.%
  mutate(Survey_Response = as.character(Survey_Response))

```

## Operator specifics

### AC Transit
```{r operator-actransit}
survey.ACT.key <- 'AC Transit'

# Prepare AC Transit-specific dictionary
dictionary.ACT <- dictionary.all %.%
  filter(Operator == survey.ACT.key)

variables.ACT <- as.character(factor(unique(unlist(dictionary.ACT$Survey_Variable, use.names = TRUE))))

# Read ACT data (weekday or weekend) and select variables of interest
survey.ACT.weekday <- read.csv('M:/Data/OnBoard/Data and Reports/AC Transit/Redhill Data as CSV/AC TRANSIT WEEKDAY CATI DATA NO POUND OR SINGLE QUOTE.csv', header = TRUE)

survey.ACT.weekday.select <- survey.ACT.weekday[ ,variables.ACT]

survey.ACT.weekend <- read.csv('M:/Data/OnBoard/Data and Reports/AC Transit/Redhill Data as CSV/AC TRANSIT WEEKEND CATI DATA NO POUND OR SINGLE QUOTE.csv', header = TRUE)

survey.ACT.weekend.select <- survey.ACT.weekend[ ,variables.ACT]

survey.ACT.select <- rbind(survey.ACT.weekday.select, survey.ACT.weekend.select)

# Reshape the data
survey.ACT.melt <- melt(survey.ACT.select, id = 'ID')
survey.ACT.melt <- select(survey.ACT.melt, ID, Survey_Variable = variable, Survey_Response = value)
survey.ACT.melt <- mutate(survey.ACT.melt, Operator = survey.ACT.key)

```


### Altamont Commuter Express
```{r operator-ace}
survey.ACE.key <- 'ACE'

# Prepare ACE-specific dictionary
dictionary.ACE <- dictionary.all %.%
  filter(Operator == survey.ACE.key)

variables.ACE <- as.character(factor(unique(unlist(dictionary.ACE$Survey_Variable, use.names = TRUE))))

# Read ACE data and select variables of interest
survey.ACE <- read.csv('M:/Data/OnBoard/Data and Reports/ACE/Redhill Data as CSV/ACE_2014 Final DataSet NO SINGLE QUOTE OR POUND.csv', header = TRUE)
survey.ACE.select <- survey.ACE[ ,variables.ACE]

# Reshape the data
survey.ACE.melt <- melt(survey.ACE.select, id = 'Survey_ID')
survey.ACE.melt <- select(survey.ACE.melt, ID = Survey_ID, Survey_Variable = variable, Survey_Response = value)
survey.ACE.melt <- mutate(survey.ACE.melt, Operator = survey.ACE.key)

```


### County Connection
```{r operator-cccta}

survey.CCC.key <- 'County Connection'

# Prepare ACE-specific dictionary
dictionary.CCC <- dictionary.all %.%
  filter(Operator == survey.CCC.key)

variables.CCC <- as.character(factor(unique(unlist(dictionary.CCC$Survey_Variable, use.names = TRUE))))

# Read ACE data and select variables of interest
survey.CCC <- read.csv('M:/Data/OnBoard/Data and Reports/County Connection/Redhill Data as CSV/County Connection CATI DATA Weekday-Weekend (With MTC Dayparts) NO POUND OR SINGLE QUOTE.csv', header = TRUE)
survey.CCC.select <- survey.CCC[ ,variables.CCC]

# Reshape the data
survey.CCC.melt <- melt(survey.CCC.select, id = 'ID')
survey.CCC.melt <- select(survey.CCC.melt, ID, Survey_Variable = variable, Survey_Response = value)
survey.CCC.melt <- mutate(survey.CCC.melt, Operator = survey.CCC.key)

```


### Golden Gate Transit (bus)
```{r operator-goldengatebus}
survey.GGT.key <- 'Golden Gate Transit'

# Prepare Golden Gate-specific dictionary
dictionary.GGT <- dictionary.all %.%
  filter(Operator == survey.GGT.key)

variables.GGT <- as.character(factor(unique(unlist(dictionary.GGT$Survey_Variable, use.names = TRUE))))

# Read GGT data (weekday or weekend) and select variables of interest
survey.GGT.weekday <- read.csv('M:/Data/OnBoard/Data and Reports/Golden Gate Transit/Redhill Data as CSV/Golden Gate Transit Weekday CATI Data NO POUND OR SINGLE QUOTE.csv', header = TRUE)

survey.GGT.weekday.select <- survey.GGT.weekday[ ,variables.GGT]

survey.GGT.weekend <- read.csv('M:/Data/OnBoard/Data and Reports/Golden Gate Transit/Redhill Data as CSV/Golden Gate Transit Weekend CATI Data NO POUND OR SINGLE QUOTE.csv', header = TRUE)

survey.GGT.weekend.select <- survey.GGT.weekend[ ,variables.GGT]

survey.GGT.select <- rbind(survey.GGT.weekday.select, survey.GGT.weekend.select)

# Reshape the data
survey.GGT.melt <- melt(survey.GGT.select, id = 'ID')
survey.GGT.melt <- select(survey.GGT.melt, ID, Survey_Variable = variable, Survey_Response = value)
survey.GGT.melt <- mutate(survey.GGT.melt, Operator = survey.GGT.key)

```


### Golden Gate Transit (ferry)
```{r operator-goldengateferry}
survey.GGF.key <- 'Golden Gate Ferry'

# Prepare Golden Gate-specific dictionary
dictionary.GGF <- dictionary.all %.%
  filter(Operator == survey.GGF.key)

variables.GGF <- as.character(factor(unique(unlist(dictionary.GGF$Survey_Variable, use.names = TRUE))))

# Read GGF data (weekday or weekend) and select variables of interest
survey.GGF.weekday <- read.csv('M:/Data/OnBoard/Data and Reports/Golden Gate Transit/Redhill Data as CSV/Golden Gate Ferry Weekday CATI Data NO POUND OR SINGLE QUOTE.csv', header = TRUE)

survey.GGF.weekday.select <- survey.GGF.weekday[ ,variables.GGF]

survey.GGF.weekend <- read.csv('M:/Data/OnBoard/Data and Reports/Golden Gate Transit/Redhill Data as CSV/Golden Gate Ferry Weekend CATI Data NO POUND OR SINGLE QUOTE.csv', header = TRUE)

survey.GGF.weekend.select <- survey.GGF.weekend[ ,variables.GGF]

survey.GGF.select <- rbind(survey.GGF.weekday.select, survey.GGF.weekend.select)

# Reshape the data
survey.GGF.melt <- melt(survey.GGF.select, id = 'ID')
survey.GGF.melt <- select(survey.GGF.melt, ID, Survey_Variable = variable, Survey_Response = value)
survey.GGF.melt <- mutate(survey.GGF.melt, Operator = survey.GGF.key)

```


### Livermore Amador Valley Transit (LAVTA or WHEELS)
```{r operator-lavta}
survey.LAV.key <- 'LAVTA'

# Prepare LAVTA-specific dictionary
dictionary.LAV <- dictionary.all %.%
  filter(Operator == survey.LAV.key)

variables.LAV <- as.character(factor(unique(unlist(dictionary.LAV$Survey_Variable, use.names = TRUE))))

# Read LAV data (weekday or weekend) and select variables of interest
survey.LAV.weekday <- read.csv('M:/Data/OnBoard/Data and Reports/LAVTA/Redhill Data as CSV/LAVTA Weekday CATI Data NO POUND OR SINGLE QUOTE.csv', header = TRUE)

survey.LAV.weekday.select <- survey.LAV.weekday[ ,variables.LAV]

survey.LAV.weekend <- read.csv('M:/Data/OnBoard/Data and Reports/LAVTA/Redhill Data as CSV/LAVTA Weekend CATI Data NO POUND OR SINGLE QUOTE.csv', header = TRUE)

survey.LAV.weekend.select <- survey.LAV.weekend[ ,variables.LAV]

survey.LAV.select <- rbind(survey.LAV.weekday.select, survey.LAV.weekend.select)

# Reshape the data
survey.LAV.melt <- melt(survey.LAV.select, id = 'ID')
survey.LAV.melt <- select(survey.LAV.melt, ID, Survey_Variable = variable, Survey_Response = value)
survey.LAV.melt <- mutate(survey.LAV.melt, Operator = survey.LAV.key)

```


### Tri-Delta
```{r operator-tridelta}
survey.TRI.key <- 'Tri-Delta'

# Prepare ACE-specific dictionary
dictionary.TRI <- dictionary.all %.%
  filter(Operator == survey.TRI.key)

variables.TRI <- as.character(factor(unique(unlist(dictionary.TRI$Survey_Variable, use.names = TRUE))))

# Read ACE data and select variables of interest
survey.TRI <- read.csv('M:/Data/OnBoard/Data and Reports/Tri Delta/As CSV/Tri Delta_OnBoard_InterceptSurvey_Aug 24_Submitted_20140826 NO SINGLE QUOTE OR POUND.csv', header = TRUE)
survey.TRI.select <- survey.TRI[ ,variables.TRI]

# Reshape the data
survey.TRI.melt <- melt(survey.TRI.select, id = 'ID')
survey.TRI.melt <- select(survey.TRI.melt, ID, Survey_Variable = variable, Survey_Response = value)
survey.TRI.melt <- mutate(survey.TRI.melt, Operator = survey.TRI.key)

```

## Combine across operators and flatten
```{r combine}
survey.combine <- rbind(survey.ACE.melt, survey.ACT.melt, survey.CCC.melt, survey.GGT.melt, survey.GGF.melt, survey.LAV.melt, survey.TRI.melt)

# Join the dictionary and prepare the categorical variables
survey.cat <- mutate(survey.combine, Survey_Response = as.character(Survey_Response))
survey.cat <- left_join(survey.cat, dictionary.cat, by = c("Operator", "Survey_Variable", "Survey_Response"))
survey.cat <- filter(survey.cat, !is.na(Generic_Variable))

# Join the dictionary and prepare the non-categorical variables
survey.non <- left_join(survey.combine, dictionary.non, by = c("Operator", "Survey_Variable"))
survey.non <- survey.non %.%
  filter(!is.na(Generic_Variable)) %.%
  mutate(Generic_Response = Survey_Response)

# Combine the categorical and non-categorical survey data and prepare to flatten
survey.cat.to_flat <- survey.cat %.%
  select(-Survey_Variable, -Survey_Response) %.%
  mutate(Generic_Response = as.factor(Generic_Response))

survey.non.to_flat <- survey.non %.%
  select(-Survey_Variable, -Survey_Response) %.%
  mutate(Generic_Response = as.factor(Generic_Response))

survey.to_flat <- rbind(survey.cat.to_flat, survey.non.to_flat)

# Put together and then take apart a unique ID when flattening
survey.to_flat <- survey.to_flat %.%
  mutate(Unique_ID = paste(ID, Operator, sep = "---")) %.%
  select(-ID, -Operator)

survey.flat <- dcast(survey.to_flat, Unique_ID ~ Generic_Variable, value.var = 'Generic_Response')

survey.flat <- cbind(survey.flat, colsplit(survey.flat$Unique_ID, "---", c("ID", "Operator")))

```

## Quality checks
```{r qaqc}

# working space

```

## Build Standard Data set variables

## Bring in Legacy SAS Data set

## Extract Tableau summaries

## Write working set to RData

## Prepare and Write public data set to CSV





