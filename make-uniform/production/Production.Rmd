---
title: "Production"
author: "David Ory"
output:
  html_document:
    theme: cosmo
    toc: yes
runtime: shiny
---

## Administration

#### Purpose
Procedure to translate any number of on-board survey data sets into a single dataset with common variables and common responses.  This is a work-in-progress production version of the procedures.  See ``../mini-example`` and ``../small-example`` for working proto-types.

#### _ISSUES_
1.  Check a few freqs comparing the input data and the derived flat file
2.  Show Shimon what's going on.

#### _TODO_
3.  Build full generalization with latest ETC -- how to handle geo-coding?  (write XY to disk for geo-coding and then re-join?)
4.  Add standard processing steps once data is in place
5.  Working solution -- build generic, process generic, bring in legacy SAS data (via CSV and R), extract any new variables from generic
6.  Add Tableau extracts
7.  Use generic for new operators
8.  Add data types before exporting to RData
9.  How to handle operators with mixed modes

## Overhead

#### Libraries
```{r overhead}
library(knitr)
library(reshape2)
suppressMessages(library(dplyr))
library(stringr)
```

#### Knitr config
```{r config, include=FALSE}
knitr::opts_chunk$set(cache=TRUE)
```

## Prepare Dictionaries
```{r prepare-dictionary}
dictionary.all <- read.csv('Dictionary.csv', header = TRUE)

# Prepare seperate dictionaries for categorical and non-categorical variables
dictionary.non <- dictionary.all %>%
  filter(Generic_Response == 'NONCATEGORICAL') %>%
  select(Operator, Survey_Variable, Generic_Variable)

dictionary.cat <- dictionary.all %>%
  filter(Generic_Response != 'NONCATEGORICAL') %>%
  mutate(Survey_Response = as.character(Survey_Response))

```

## Operator specifics

### AC Transit
```{r operator-actransit}
survey.ACT.key  <- 'AC Transit'
survey.ACT.year <- 2012
survey.ACT.tech <- 'local bus'

# Prepare operator-specific-specific dictionary
dictionary.ACT <- dictionary.all %>%
  filter(Operator == survey.ACT.key)

variables.ACT <- as.character(factor(unique(unlist(dictionary.ACT$Survey_Variable, use.names = TRUE))))

# Read data (weekday or weekend) and select variables of interest
survey.ACT.weekday <- read.csv('M:/Data/OnBoard/Data and Reports/AC Transit/Redhill Data as CSV/AC TRANSIT WEEKDAY CATI DATA NO POUND OR SINGLE QUOTE.csv', header = TRUE)

survey.ACT.weekday.select <- survey.ACT.weekday[ ,variables.ACT]

survey.ACT.weekend <- read.csv('M:/Data/OnBoard/Data and Reports/AC Transit/Redhill Data as CSV/AC TRANSIT WEEKEND CATI DATA NO POUND OR SINGLE QUOTE.csv', header = TRUE)

survey.ACT.weekend.select <- survey.ACT.weekend[ ,variables.ACT]

survey.ACT.select <- rbind(survey.ACT.weekday.select, survey.ACT.weekend.select)

# Reshape the data
survey.ACT.melt <- melt(survey.ACT.select, id = 'ID')
survey.ACT.melt <- select(survey.ACT.melt, ID, Survey_Variable = variable, Survey_Response = value)
survey.ACT.melt <- mutate(survey.ACT.melt, Operator = survey.ACT.key)
survey.ACT.melt <- mutate(survey.ACT.melt, survey_year = survey.ACT.year)
survey.ACT.melt <- mutate(survey.ACT.melt, survey_tech = survey.ACT.tech)

# Clean up
remove(survey.ACT.key, survey.ACT.year, survey.ACT.tech, dictionary.ACT, variables.ACT, survey.ACT.weekday, survey.ACT.weekend, survey.ACT.weekday.select, survey.ACT.weekend.select, survey.ACT.select)
```


### Altamont Commuter Express
```{r operator-ace}
survey.ACE.key  <- 'ACE'
survey.ACE.year <- 2014
survey.ACE.tech <- 'commuter rail'

# Prepare operator-specific dictionary
dictionary.ACE <- dictionary.all %>%
  filter(Operator == survey.ACE.key)

variables.ACE <- as.character(factor(unique(unlist(dictionary.ACE$Survey_Variable, use.names = TRUE))))

# Read ACE data and select variables of interest
survey.ACE <- read.csv('M:/Data/OnBoard/Data and Reports/ACE/Redhill Data as CSV/ACE_2014 Final DataSet NO SINGLE QUOTE OR POUND.csv', header = TRUE)
survey.ACE.select <- survey.ACE[ ,variables.ACE]

# Reshape the data
survey.ACE.melt <- melt(survey.ACE.select, id = 'Survey_ID')
survey.ACE.melt <- select(survey.ACE.melt, ID = Survey_ID, Survey_Variable = variable, Survey_Response = value)
survey.ACE.melt <- mutate(survey.ACE.melt, Operator = survey.ACE.key)
survey.ACE.melt <- mutate(survey.ACE.melt, survey_year = survey.ACE.year)
survey.ACE.melt <- mutate(survey.ACE.melt, survey_tech = survey.ACE.tech)

# Clean up
remove(survey.ACE.key, survey.ACE.year, survey.ACE.tech, dictionary.ACE, variables.ACE, survey.ACE, survey.ACE.select)
```

### Caltrain Pilot
```{r operator-caltrain}
survey.CAL.key  <- 'Caltrain Pilot'
survey.CAL.year <- 2014
survey.CAL.tech <- 'commuter rail'

# Prepare operator-specific dictionary
dictionary.CAL <- dictionary.all %>%
  filter(Operator == survey.CAL.key)

variables.CAL <- as.character(factor(unique(unlist(dictionary.CAL$Survey_Variable, use.names = TRUE))))

# Read data and select variables of interest
survey.CAL <- read.csv('M:/Data/OnBoard/Data and Reports/Caltrain/As CSV/Caltrain_PilotTest_MainSurvey_Database_SubmittedOct16 NO POUND OR SINGLE QUOTE.csv', header = TRUE)
survey.CAL.select <- survey.CAL[ ,variables.CAL]

# Reshape the data
survey.CAL.melt <- melt(survey.CAL.select, id = 'ID')
survey.CAL.melt <- select(survey.CAL.melt, ID, Survey_Variable = variable, Survey_Response = value)
survey.CAL.melt <- mutate(survey.CAL.melt, Operator = survey.CAL.key)
survey.CAL.melt <- mutate(survey.CAL.melt, survey_year = survey.CAL.year)
survey.CAL.melt <- mutate(survey.CAL.melt, survey_tech = survey.CAL.tech)

# Clean up
remove(survey.CAL.key, survey.CAL.year, survey.CAL.tech, dictionary.CAL, variables.CAL, survey.CAL, survey.CAL.select)
```



### County Connection
```{r operator-cccta}
survey.CCC.key  <- 'County Connection'
survey.CCC.year <- 2012
survey.CCC.tech <- 'local bus'

# Prepare operator-specific dictionary
dictionary.CCC <- dictionary.all %>%
  filter(Operator == survey.CCC.key)

variables.CCC <- as.character(factor(unique(unlist(dictionary.CCC$Survey_Variable, use.names = TRUE))))

# Read data and select variables of interest
survey.CCC <- read.csv('M:/Data/OnBoard/Data and Reports/County Connection/Redhill Data as CSV/County Connection CATI DATA Weekday-Weekend (With MTC Dayparts) NO POUND OR SINGLE QUOTE.csv', header = TRUE)
survey.CCC.select <- survey.CCC[ ,variables.CCC]

# Reshape the data
survey.CCC.melt <- melt(survey.CCC.select, id = 'ID')
survey.CCC.melt <- select(survey.CCC.melt, ID, Survey_Variable = variable, Survey_Response = value)
survey.CCC.melt <- mutate(survey.CCC.melt, Operator = survey.CCC.key)
survey.CCC.melt <- mutate(survey.CCC.melt, survey_year = survey.CCC.year)
survey.CCC.melt <- mutate(survey.CCC.melt, survey_tech = survey.CCC.tech)

# Clean up
remove(survey.CCC.key, survey.CCC.year, survey.CCC.tech, dictionary.CCC, variables.CCC, survey.CCC, survey.CCC.select)
```


### Golden Gate Transit (bus)
```{r operator-goldengatebus}
survey.GGT.key  <- 'Golden Gate Transit'
survey.GGT.year <- 2013
survey.GGT.tech <- 'express bus'

# Prepare operator-specific dictionary
dictionary.GGT <- dictionary.all %>%
  filter(Operator == survey.GGT.key)

variables.GGT <- as.character(factor(unique(unlist(dictionary.GGT$Survey_Variable, use.names = TRUE))))

# Read data (weekday or weekend) and select variables of interest
survey.GGT.weekday <- read.csv('M:/Data/OnBoard/Data and Reports/Golden Gate Transit/Redhill Data as CSV/Golden Gate Transit Weekday CATI Data NO POUND OR SINGLE QUOTE.csv', header = TRUE)

survey.GGT.weekday.select <- survey.GGT.weekday[ ,variables.GGT]

survey.GGT.weekend <- read.csv('M:/Data/OnBoard/Data and Reports/Golden Gate Transit/Redhill Data as CSV/Golden Gate Transit Weekend CATI Data NO POUND OR SINGLE QUOTE.csv', header = TRUE)

survey.GGT.weekend.select <- survey.GGT.weekend[ ,variables.GGT]

survey.GGT.select <- rbind(survey.GGT.weekday.select, survey.GGT.weekend.select)

# Reshape the data
survey.GGT.melt <- melt(survey.GGT.select, id = 'ID')
survey.GGT.melt <- select(survey.GGT.melt, ID, Survey_Variable = variable, Survey_Response = value)
survey.GGT.melt <- mutate(survey.GGT.melt, Operator = survey.GGT.key)
survey.GGT.melt <- mutate(survey.GGT.melt, survey_year = survey.GGT.year)
survey.GGT.melt <- mutate(survey.GGT.melt, survey_tech = survey.GGT.tech)

# Clean up
remove(survey.GGT.key, survey.GGT.year, survey.GGT.tech, dictionary.GGT, variables.GGT, survey.GGT.weekday, survey.GGT.weekend, survey.GGT.weekday.select, survey.GGT.weekend.select, survey.GGT.select)
```


### Golden Gate Transit (ferry)
```{r operator-goldengateferry}
survey.GGF.key  <- 'Golden Gate Ferry'
survey.GGF.year <- 2013
survey.GGF.tech <- 'ferry'

# Prepare operator-specific dictionary
dictionary.GGF <- dictionary.all %>%
  filter(Operator == survey.GGF.key)

variables.GGF <- as.character(factor(unique(unlist(dictionary.GGF$Survey_Variable, use.names = TRUE))))

# Read data (weekday or weekend) and select variables of interest
survey.GGF.weekday <- read.csv('M:/Data/OnBoard/Data and Reports/Golden Gate Transit/Redhill Data as CSV/Golden Gate Ferry Weekday CATI Data NO POUND OR SINGLE QUOTE.csv', header = TRUE)

survey.GGF.weekday.select <- survey.GGF.weekday[ ,variables.GGF]

survey.GGF.weekend <- read.csv('M:/Data/OnBoard/Data and Reports/Golden Gate Transit/Redhill Data as CSV/Golden Gate Ferry Weekend CATI Data NO POUND OR SINGLE QUOTE.csv', header = TRUE)

survey.GGF.weekend.select <- survey.GGF.weekend[ ,variables.GGF]

survey.GGF.select <- rbind(survey.GGF.weekday.select, survey.GGF.weekend.select)

# Reshape the data
survey.GGF.melt <- melt(survey.GGF.select, id = 'ID')
survey.GGF.melt <- select(survey.GGF.melt, ID, Survey_Variable = variable, Survey_Response = value)
survey.GGF.melt <- mutate(survey.GGF.melt, Operator = survey.GGF.key)
survey.GGF.melt <- mutate(survey.GGF.melt, survey_year = survey.GGF.year)
survey.GGF.melt <- mutate(survey.GGF.melt, survey_tech = survey.GGF.tech)

# Clean up
remove(survey.GGF.key, survey.GGF.year, survey.GGF.tech, dictionary.GGF, variables.GGF, survey.GGF.weekday, survey.GGF.weekend, survey.GGF.weekday.select, survey.GGF.weekend.select, survey.GGF.select)
```


### Livermore Amador Valley Transit (LAVTA or WHEELS)
```{r operator-lavta}
survey.LAV.key  <- 'LAVTA'
survey.LAV.year <- 2013
survey.LAV.tech <- 'local bus'

# Prepare operator-specific dictionary
dictionary.LAV <- dictionary.all %>%
  filter(Operator == survey.LAV.key)

variables.LAV <- as.character(factor(unique(unlist(dictionary.LAV$Survey_Variable, use.names = TRUE))))

# Read data (weekday or weekend) and select variables of interest
survey.LAV.weekday <- read.csv('M:/Data/OnBoard/Data and Reports/LAVTA/Redhill Data as CSV/LAVTA Weekday CATI Data NO POUND OR SINGLE QUOTE.csv', header = TRUE)

survey.LAV.weekday.select <- survey.LAV.weekday[ ,variables.LAV]

survey.LAV.weekend <- read.csv('M:/Data/OnBoard/Data and Reports/LAVTA/Redhill Data as CSV/LAVTA Weekend CATI Data NO POUND OR SINGLE QUOTE.csv', header = TRUE)

survey.LAV.weekend.select <- survey.LAV.weekend[ ,variables.LAV]

survey.LAV.select <- rbind(survey.LAV.weekday.select, survey.LAV.weekend.select)

# Reshape the data
survey.LAV.melt <- melt(survey.LAV.select, id = 'ID')
survey.LAV.melt <- select(survey.LAV.melt, ID, Survey_Variable = variable, Survey_Response = value)
survey.LAV.melt <- mutate(survey.LAV.melt, Operator = survey.LAV.key)
survey.LAV.melt <- mutate(survey.LAV.melt, survey_year = survey.LAV.year)
survey.LAV.melt <- mutate(survey.LAV.melt, survey_tech = survey.LAV.tech)

# Clean up
remove(survey.LAV.key, survey.LAV.year, survey.LAV.tech, dictionary.LAV, variables.LAV, survey.LAV.weekday, survey.LAV.weekend, survey.LAV.weekday.select, survey.LAV.weekend.select, survey.LAV.select)
```


### Napa Vine
```{r operator-napa}
survey.NAP.key  <- 'Napa Vine'
survey.NAP.year <- 2014
survey.NAP.tech <- 'local bus'

# Prepare operator-specific dictionary
dictionary.NAP <- dictionary.all %>%
  filter(Operator == survey.NAP.key)

variables.NAP <- as.character(factor(unique(unlist(dictionary.NAP$Survey_Variable, use.names = TRUE))))

# Read data and select variables of interest
survey.NAP <- read.csv('M:/Data/OnBoard/Data and Reports/Napa Vine/As CSV/Napa Vine Tranist OD Survey Data_Aug24_Submitted_20140826 NO POUND OR SINGLE QUOTE.csv', header = TRUE)
survey.NAP.select <- survey.NAP[ ,variables.NAP]

# Reshape the data
survey.NAP.melt <- melt(survey.NAP.select, id = 'ID')
survey.NAP.melt <- select(survey.NAP.melt, ID, Survey_Variable = variable, Survey_Response = value)
survey.NAP.melt <- mutate(survey.NAP.melt, Operator = survey.NAP.key)
survey.NAP.melt <- mutate(survey.NAP.melt, survey_year = survey.NAP.year)
survey.NAP.melt <- mutate(survey.NAP.melt, survey_tech = survey.NAP.tech)

# Clean up
remove(survey.NAP.key, survey.NAP.year, survey.NAP.tech, dictionary.NAP, variables.NAP, survey.NAP, survey.NAP.select)
```


### Petaluma
```{r operator-petaluma}
survey.PET.key  <- 'Petaluma'
survey.PET.year <- 2012
survey.PET.tech <- 'local bus'

# Prepare operator-specific dictionary
dictionary.PET <- dictionary.all %>%
  filter(Operator == survey.PET.key)

variables.PET <- as.character(factor(unique(unlist(dictionary.PET$Survey_Variable, use.names = TRUE))))

# Read data and select variables of interest
survey.PET <- read.csv('M:/Data/OnBoard/Data and Reports/Petaluma/Redhill Data as CSV/Petaluma 2012 CATI Data NO POUND OR SINGLE QUOTE.csv', header = TRUE)
survey.PET.select <- survey.PET[ ,variables.PET]

# Reshape the data
survey.PET.melt <- melt(survey.PET.select, id = 'ID')
survey.PET.melt <- select(survey.PET.melt, ID, Survey_Variable = variable, Survey_Response = value)
survey.PET.melt <- mutate(survey.PET.melt, Operator = survey.PET.key)
survey.PET.melt <- mutate(survey.PET.melt, survey_year = survey.PET.year)
survey.PET.melt <- mutate(survey.PET.melt, survey_tech = survey.PET.tech)

# Clean up
remove(survey.PET.key, survey.PET.year, survey.PET.tech, dictionary.PET, variables.PET, survey.PET, survey.PET.select)
```


### SamTrans
```{r operator-samtrans}
survey.SAM.key  <- 'SamTrans'
survey.SAM.year <- 2013
survey.SAM.tech <- 'local bus'

# Prepare operator-specific dictionary
dictionary.SAM <- dictionary.all %>%
  filter(Operator == survey.SAM.key)

variables.SAM <- as.character(factor(unique(unlist(dictionary.SAM$Survey_Variable, use.names = TRUE))))

# Read data (weekday or weekend) and select variables of interest
survey.SAM.weekday <- read.csv('M:/Data/OnBoard/Data and Reports/SamTrans/Redhill Data as CSV/SamTrans Weekday CATI Data NO POUND OR SINGLE QUOTE.csv', header = TRUE)

survey.SAM.weekday.select <- survey.SAM.weekday[ ,variables.SAM]

survey.SAM.weekend <- read.csv('M:/Data/OnBoard/Data and Reports/SamTrans/Redhill Data as CSV/SamTrans Weekend CATI Data NO POUND OR SINGLE QUOTE.csv', header = TRUE)

survey.SAM.weekend.select <- survey.SAM.weekend[ ,variables.SAM]

survey.SAM.select <- rbind(survey.SAM.weekday.select, survey.SAM.weekend.select)

# Reshape the data
survey.SAM.melt <- melt(survey.SAM.select, id = 'ID')
survey.SAM.melt <- select(survey.SAM.melt, ID, Survey_Variable = variable, Survey_Response = value)
survey.SAM.melt <- mutate(survey.SAM.melt, Operator = survey.SAM.key)
survey.SAM.melt <- mutate(survey.SAM.melt, survey_year = survey.SAM.year)
survey.SAM.melt <- mutate(survey.SAM.melt, survey_tech = survey.SAM.tech)

# Clean up
remove(survey.SAM.key, survey.SAM.year, survey.SAM.tech, dictionary.SAM, variables.SAM, survey.SAM.weekday, survey.SAM.weekend, survey.SAM.weekday.select, survey.SAM.weekend.select, survey.SAM.select)
```


### Santa Rosa CityBus
```{r operator-santarosa}
survey.SRC.key  <- 'Santa Rosa CityBus'
survey.SRC.year <- 2012
survey.SRC.tech <- 'local bus'

# Prepare operator-specific dictionary
dictionary.SRC <- dictionary.all %>%
  filter(Operator == survey.SRC.key)

variables.SRC <- as.character(factor(unique(unlist(dictionary.SRC$Survey_Variable, use.names = TRUE))))

# Read data and select variables of interest
survey.SRC <- read.csv('M:/Data/OnBoard/Data and Reports/Santa Rosa CityBus/Redhill Data as CSV/CityBus2012 CATI Data (updated) NO POUND OR SINGLE QUOTE.csv', header = TRUE)
survey.SRC.select <- survey.SRC[ ,variables.SRC]

# Reshape the data
survey.SRC.melt <- melt(survey.SRC.select, id = 'ID')
survey.SRC.melt <- select(survey.SRC.melt, ID, Survey_Variable = variable, Survey_Response = value)
survey.SRC.melt <- mutate(survey.SRC.melt, Operator = survey.SRC.key)
survey.SRC.melt <- mutate(survey.SRC.melt, survey_year = survey.SRC.year)
survey.SRC.melt <- mutate(survey.SRC.melt, survey_tech = survey.SRC.tech)

# Clean up
remove(survey.SRC.key, survey.SRC.year, survey.SRC.tech, dictionary.SRC, variables.SRC, survey.SRC, survey.SRC.select)
```


### Sonoma County
```{r operator-sonoma}
survey.SON.key  <- 'Sonoma County'
survey.SON.year <- 2012
survey.SON.tech <- 'local bus'

# Prepare operator-specific dictionary
dictionary.SON <- dictionary.all %>%
  filter(Operator == survey.SON.key)

variables.SON <- as.character(factor(unique(unlist(dictionary.SON$Survey_Variable, use.names = TRUE))))

# Read data and select variables of interest
survey.SON <- read.csv('M:/Data/OnBoard/Data and Reports/Sonoma County/Redhill Data as CSV/Sonoma County Transit 2012 CATI Data NO POUND OR SINGLE QUOTE.csv', header = TRUE)
survey.SON.select <- survey.SON[ ,variables.SON]

# Reshape the data
survey.SON.melt <- melt(survey.SON.select, id = 'ID')
survey.SON.melt <- select(survey.SON.melt, ID, Survey_Variable = variable, Survey_Response = value)
survey.SON.melt <- mutate(survey.SON.melt, Operator = survey.SON.key)
survey.SON.melt <- mutate(survey.SON.melt, survey_year = survey.SON.year)
survey.SON.melt <- mutate(survey.SON.melt, survey_tech = survey.SON.tech)

# Clean up
remove(survey.SON.key, survey.SON.year, survey.SON.tech, dictionary.SON, variables.SON, survey.SON, survey.SON.select)
```


### Tri-Delta
```{r operator-tridelta}
survey.TRI.key  <- 'Tri-Delta'
survey.TRI.year <- 2014
survey.TRI.tech <- 'local bus'

# Prepare dictionary
dictionary.TRI <- dictionary.all %>%
  filter(Operator == survey.TRI.key)

variables.TRI <- as.character(factor(unique(unlist(dictionary.TRI$Survey_Variable, use.names = TRUE))))

# Read data and select variables of interest
survey.TRI <- read.csv('M:/Data/OnBoard/Data and Reports/Tri Delta/As CSV/Tri Delta_OnBoard_InterceptSurvey_Aug 24_Submitted_20140826 NO SINGLE QUOTE OR POUND.csv', header = TRUE)
survey.TRI.select <- survey.TRI[ ,variables.TRI]

# Reshape the data
survey.TRI.melt <- melt(survey.TRI.select, id = 'ID')
survey.TRI.melt <- select(survey.TRI.melt, ID, Survey_Variable = variable, Survey_Response = value)
survey.TRI.melt <- mutate(survey.TRI.melt, Operator = survey.TRI.key)
survey.TRI.melt <- mutate(survey.TRI.melt, survey_year = survey.TRI.year)
survey.TRI.melt <- mutate(survey.TRI.melt, survey_tech = survey.TRI.tech)

# Clean up
remove(survey.TRI.key, survey.TRI.year, survey.TRI.tech, dictionary.TRI, variables.TRI, survey.TRI, survey.TRI.select)
```


### Union City
```{r operator-union}
survey.UCT.key  <- 'Union City'
survey.UCT.year <- 2013
survey.UCT.tech <- 'local bus'

# Prepare operator-specific dictionary
dictionary.UCT <- dictionary.all %>%
  filter(Operator == survey.UCT.key)

variables.UCT <- as.character(factor(unique(unlist(dictionary.UCT$Survey_Variable, use.names = TRUE))))

# Read data and select variables of interest
survey.UCT <- read.csv('M:/Data/OnBoard/Data and Reports/Union City/Redhill Data as CSV/Union City Transit CATI Data NO POUND OR SINGLE QUOTE.csv', header = TRUE)
survey.UCT.select <- survey.UCT[ ,variables.UCT]

# Reshape the data
survey.UCT.melt <- melt(survey.UCT.select, id = 'ID')
survey.UCT.melt <- select(survey.UCT.melt, ID, Survey_Variable = variable, Survey_Response = value)
survey.UCT.melt <- mutate(survey.UCT.melt, Operator = survey.UCT.key)
survey.UCT.melt <- mutate(survey.UCT.melt, survey_year = survey.UCT.year)
survey.UCT.melt <- mutate(survey.UCT.melt, survey_tech = survey.UCT.tech)

# Clean up
remove(survey.UCT.key, survey.UCT.year, survey.UCT.tech, dictionary.UCT, variables.UCT, survey.UCT, survey.UCT.select)
```


### Water Emergency Transit Admin (aka San Francisco Bay Ferry)
```{r operator-ferry}
survey.WET.key  <- 'SF Bay Ferry'
survey.WET.year <- 2013
survey.WET.tech <- 'ferry'

# Prepare operator-specific dictionary
dictionary.WET <- dictionary.all %>%
  filter(Operator == survey.WET.key)

variables.WET <- as.character(factor(unique(unlist(dictionary.WET$Survey_Variable, use.names = TRUE))))

# Read data (weekday or weekend) and select variables of interest
survey.WET.weekday <- read.csv('M:/Data/OnBoard/Data and Reports/WETA/Redhill Data as CSV/WETA Weekday CATI Data NO POUND OR SINGLE QUOTE.csv', header = TRUE)

survey.WET.weekday.select <- survey.WET.weekday[ ,variables.WET]

survey.WET.weekend <- read.csv('M:/Data/OnBoard/Data and Reports/WETA/Redhill Data as CSV/WETA Weekend CATI Data NO POUND OR SINGLE QUOTE.csv', header = TRUE)

survey.WET.weekend.select <- survey.WET.weekend[ ,variables.WET]

survey.WET.select <- rbind(survey.WET.weekday.select, survey.WET.weekend.select)

# Reshape the data
survey.WET.melt <- melt(survey.WET.select, id = 'ID')
survey.WET.melt <- select(survey.WET.melt, ID, Survey_Variable = variable, Survey_Response = value)
survey.WET.melt <- mutate(survey.WET.melt, Operator = survey.WET.key)
survey.WET.melt <- mutate(survey.WET.melt, survey_year = survey.WET.year)
survey.WET.melt <- mutate(survey.WET.melt, survey_tech = survey.WET.tech)

# Clean up
remove(survey.WET.key, survey.WET.year, survey.WET.tech, dictionary.WET, variables.WET, survey.WET.weekday, survey.WET.weekend, survey.WET.weekday.select, survey.WET.weekend.select, survey.WET.select)
```


## Combine across operators and flatten
```{r combine}
survey.combine <- rbind(survey.ACE.melt, 
                        survey.ACT.melt,
                        survey.CAL.melt,
                        survey.CCC.melt, 
                        survey.GGT.melt, 
                        survey.GGF.melt, 
                        survey.LAV.melt, 
                        survey.NAP.melt, 
                        survey.PET.melt, 
                        survey.SAM.melt, 
                        survey.SRC.melt, 
                        survey.SON.melt,
                        survey.TRI.melt,
                        survey.UCT.melt,
                        survey.WET.melt)

# Join the dictionary and prepare the categorical variables
survey.cat <- mutate(survey.combine, Survey_Response = as.character(Survey_Response))
survey.cat <- left_join(survey.cat, dictionary.cat, by = c("Operator", "Survey_Variable", "Survey_Response"))
survey.cat <- filter(survey.cat, !is.na(Generic_Variable))

# Join the dictionary and prepare the non-categorical variables
survey.non <- left_join(survey.combine, dictionary.non, by = c("Operator", "Survey_Variable"))
survey.non <- survey.non %>%
  filter(!is.na(Generic_Variable)) %>%
  mutate(Generic_Response = Survey_Response)

# Combine the categorical and non-categorical survey data and prepare to flatten
survey.cat.to_flat <- survey.cat %>%
  select(-Survey_Variable, -Survey_Response) %>%
  mutate(Generic_Response = as.factor(Generic_Response))

survey.non.to_flat <- survey.non %>%
  select(-Survey_Variable, -Survey_Response) %>%
  mutate(Generic_Response = as.factor(Generic_Response))

survey.to_flat <- rbind(survey.cat.to_flat, survey.non.to_flat)

# Put together and then take apart a unique ID when flattening
survey.to_flat <- survey.to_flat %>%
  mutate(Unique_ID = paste(ID, Operator, survey_year, sep = "---")) %>%
  select(-ID, -Operator, -survey_year)

survey.flat <- dcast(survey.to_flat, Unique_ID ~ Generic_Variable, value.var = 'Generic_Response')

survey.flat <- cbind(survey.flat, colsplit(survey.flat$Unique_ID, "---", c("ID", "Operator", "survey_year")))

# Add in survey technology
survey.tech <- survey.combine %>%
  select(ID, Operator, survey_year, survey_tech)

survey.flat <- left_join(survey.flat, survey.tech, by = c("ID", "Operator", "survey_year"))

remove(dictionary.cat, dictionary.non, survey.cat, survey.non, survey.cat.to_flat, survey.non.to_flat, survey.to_flat, survey.tech)
remove(survey.ACE.melt, 
       survey.ACT.melt,
       survey.CAL.melt,
       survey.CCC.melt, 
       survey.GGT.melt, 
       survey.GGF.melt, 
       survey.LAV.melt, 
       survey.NAP.melt, 
       survey.PET.melt, 
       survey.SAM.melt, 
       survey.SRC.melt, 
       survey.SON.melt,
       survey.TRI.melt,
       survey.UCT.melt,
       survey.WET.melt)

```

## Quality checks
```{r qaqc}

# table(survey.flat$Operator)
# table(survey.flat$orig_purp)
# temp <- survey.flat %>%
#   filter(Operator == 'Napa Vine')
# 
# temp <- survey.flat %>%
#   group_by(Operator, orig_purp) %>%
#   summarise(Count = n())

```

## Method Library for Standardization
```{r methods}
# Set Operator Name
Set_Operator_Name <- function(input_vector){
  
  input_df <- as.data.frame(input_vector)
  colnames(input_df) <- c("input_field")
  
  output_df <- input_df %>%
    mutate(output_field = ifelse(!is.na(input_field), "None", input_field)) %>%
    
    # BART, AMTRAK, and Caltrain may be named in route names, so do first, then overwrite
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("Amtrak")) > 0L, "AMTRAK", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("BART")) > 0L, "BART", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("Caltrain")) > 0L, "CALTRAIN", output_field)) %>%
    
    # Transit Agencies
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("AC Transit")) > 0L, "AC TRANSIT", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("AirBART")) > 0L, "MUNI", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("Capitol Corridor")) > 0L, "AMTRAK", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("County Connection")) > 0L,"COUNTY CONNECTION", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("Fairfield and")) > 0L,"FAIRFIELD-SUISUN",output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("Golden Gate Tran")) > 0L, "GOLDEN GATE TRANSIT", output_field)) %>%
     mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("Golden Gate Ferry")) > 0L, "GOLDEN GATE FERRY", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("Muni")) > 0L, "MUNI", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("SamTrans")) > 0L, "SAMTRANS",  output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("SF Bay Ferry")) > 0L, "SF BAY FERRY", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("Soltrans")) > 0L, "SOLTRANS", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("Tri Delta")) > 0L, "TRI-DELTA",  output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("WestCAT")) > 0L, "WESTCAT",  output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("VINE")) > 0L, "NAPA VINE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("VTA")) > 0L, "VTA", output_field)) %>% 
    
    # OTHER
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("Stanford")) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("Commuter shuttle")) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("Corinthian lines shuttle")) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("Caltrain- Shuttles Genentech")) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("Kaiser shuttle")) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("San Jose airport shuttle")) > 0L,  "PRIVATE SHUTTLE", output_field))
  
  return(output_df$output_field)
}

# Set Technology
Set_Base_Technology <- function(input_vector){
  
  operator = c("AC TRANSIT",        "AIR BART",         "AMTRAK",              "BART",              "CALTRAIN",
               "COUNTY CONNECTION", "FAIRFIELD-SUISUN", "GOLDEN GATE TRANSIT", "GOLDEN GATE FERRY", "MUNI", 
               "NAPA VINE",         "SAMTRANS",         "SF BAY FERRY",        "SOLTRANS",          "TRI-DELTA", 
               "WESTCAT",           "VTA",              "OTHER",               "PRIVATE SHUTTLE")
  
  technology = c("local bus", "local bus", "commuter rail", "heavy rail", "commuter rail",
                 "local bus", "local bus", "express bus",   "ferry",      "local bus", 
                 "local bus", "local bus", "ferry",         "local bus",  "local bus",
                 "local bus", "local bus", "local bus",     "local bus")
  
  tech_df <- data.frame(operator, technology)
  
  
  input_df <- as.data.frame(input_vector)
  colnames(input_df) <- c("operator")
  input_df <- mutate(input_df, operator = as.character(operator))
  
  output_df <- left_join(input_df, tech_df, by = c("operator"))
  
  return(output_df$technology)
}

# Update Technology
Update_Technology <- function(input_vector){
  
  input_df <- as.data.frame(input_vector)
  colnames(input_df) <- c("input_field")
  
  output_df <- input_df %>%
    mutate(output_field = ifelse(!is.na(input_field), "No Update", input_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & 
                                   str_count(input_field, ignore.case("Muni")) > 0L &
                                   str_count(input_field, ignore.case("Light Rail")) > 0L, "light rail", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & 
                                   str_count(input_field, ignore.case("VTA")) > 0L &
                                   str_count(input_field, ignore.case("Light Rail")) > 0L, "light rail", output_field))
  
  return(output_df$output_field)
}

```


## Build Standard variables
```{r standard-variables}
# Step 1:  Age-related transformations
# -------------------------------------------------------------------------------------

# Standardize year born
survey.standard <- survey.flat %>%
  mutate(year_born = ifelse(is.na(year_born_two_digit), as.numeric(year_born_four_digit), as.numeric(year_born_two_digit) + 1900)) %>%
  select(-year_born_two_digit, -year_born_four_digit)

# Manual fixes to year born
survey.standard <- survey.standard %>%
  mutate(year_born = ifelse(year_born == 1900, 2000, year_born)) %>%
  mutate(year_born = ifelse(year_born == 1901, 2001, year_born)) %>%
  mutate(year_born = ifelse(year_born == 3884, 1984, year_born))

table(survey.standard$year_born)

# Compute approximate respondent age 
survey.standard <- survey.standard %>%
  mutate(approximate_age = survey_year - year_born)

table(survey.standard$approximate_age)

# Step 2:  Trip- and tour-purpose-related transformations
# -------------------------------------------------------------------------------------

# Refine school purpose
survey.standard <- survey.standard %>%
  mutate(orig_purp = ifelse(orig_purp == "school", "high school", orig_purp)) %>%
  mutate(orig_purp = ifelse(orig_purp == "school" & approximate_age < 14, "grade_school", orig_purp))

# (Approximate) Tour purpose
survey.standard <- survey.standard %>%
  mutate(tour_purp = 'missing') %>%
  
  # workers -- simple
  mutate(tour_purp = ifelse(tour_purp == 'missing' & orig_purp == 'home' & dest_purp == 'work', 'work', tour_purp)) %>%
  mutate(tour_purp = ifelse(tour_purp == 'missing' & orig_purp == 'work' & dest_purp == 'home', 'work', tour_purp)) %>%
  
  # students -- simple
  mutate(tour_purp = ifelse(tour_purp == 'missing' & (orig_purp == 'grade school' | dest_purp == 'grade school'), 'grade school', tour_purp)) %>%
  mutate(tour_purp = ifelse(tour_purp == 'missing' & (orig_purp == 'high school'  | dest_purp == 'high school'),  'high  school', tour_purp)) %>%
  
  # non-working university students
  mutate(tour_purp = ifelse(tour_purp == 'missing' & worker_status == 'non-worker' & (orig_purp == 'college'  | dest_purp == 'college'),  'university', tour_purp)) %>%
  
  # non-workers, non-students, home-based travel
  mutate(tour_purp = ifelse(tour_purp == 'missing' & worker_status == 'non-worker' & student_status == 'non-student' & orig_purp == 'home', dest_purp, tour_purp)) %>%
  mutate(tour_purp = ifelse(tour_purp == 'missing' & worker_status == 'non-worker' & student_status == 'non-student' & dest_purp == 'home', orig_purp, tour_purp)) %>%
  mutate(tour_purp = ifelse(tour_purp == 'missing' & worker_status == 'non-worker' & student_status == 'non-student' & orig_purp == dest_purp, orig_purp, tour_purp)) %>%
  
  # non-workers, non-students, non-home-based (which we know from above implementation) escorting travel
  mutate(tour_purp = ifelse(tour_purp == 'missing' & worker_status == 'non-worker' & student_status == 'non-student' & (orig_purp == 'escorting' | dest_purp == 'escorting'), 'escorting', tour_purp)) %>%
  
  # university is present, but work is not, then university
  mutate(tour_purp = ifelse(tour_purp == 'missing' & at_work_prior_to_orig_purp == 'not at work before surveyed trip' & at_work_after_dest_purp == 'not at work after surveyed trip' & (orig_purp == 'college' | dest_purp == 'college'), 'university', tour_purp)) %>%
  
  # if work before trip and home after, assume work tour
  mutate(tour_purp = ifelse(tour_purp == 'missing' & at_work_prior_to_orig_purp == 'at work before surveyed trip' & dest_purp == 'home', 'work', tour_purp)) %>%
  
  # if work after trip and home before, assume work tour
   mutate(tour_purp = ifelse(tour_purp == 'missing' & at_work_after_dest_purp == 'at work after surveyed trip' & orig_purp == 'home', 'work', tour_purp)) %>%
  
  # if non-worker, school before trip and home after, over 18, university tour
   mutate(tour_purp = ifelse(tour_purp == 'missing' & worker_status == 'non-worker' & at_school_prior_to_orig_purp == 'at school before surveyed trip' & approximate_age > 18 & dest_purp == 'home', 'university', tour_purp)) %>%
  
  # if non-worker, school after trip and home before, over 18, university tour
   mutate(tour_purp = ifelse(tour_purp == 'missing' & worker_status == 'non-worker' & at_school_after_dest_purp == 'at school after surveyed trip' & approximate_age > 18 & orig_purp == 'home', 'college', tour_purp)) %>%
  
    # if non-worker, school before trip and home after, 14 to 18, high school tour
   mutate(tour_purp = ifelse(tour_purp == 'missing' & worker_status == 'non-worker' & at_school_prior_to_orig_purp == 'at school before surveyed trip' & approximate_age <= 18 & approximate_age >= 14 & dest_purp == 'home', 'high school', tour_purp)) %>%
  
  # if non-worker, school after trip and home before, 14 to 18, high school tour
   mutate(tour_purp = ifelse(tour_purp == 'missing' & worker_status == 'non-worker' & at_school_after_dest_purp == 'at school after surveyed trip' & approximate_age <= 18 & approximate_age >= 14 & orig_purp == 'home', 'high school', tour_purp)) %>%
  
  # if no work before or after, but work is a leg, assume a work tour
  mutate(tour_purp = ifelse(tour_purp == 'missing' & at_work_prior_to_orig_purp == 'not at work before surveyed trip' & at_work_after_dest_purp == 'not at work after surveyed trip' & (orig_purp == 'work' | dest_purp == 'work'), 'work', tour_purp)) %>%
  
  # at work tours
  mutate(tour_purp = ifelse(tour_purp == 'missing' & at_work_prior_to_orig_purp == 'at work before surveyed trip' & dest_purp == 'work', 'at work', tour_purp)) %>%
  mutate(tour_purp = ifelse(tour_purp == 'missing' & at_work_after_dest_purp == 'at work after surveyed trip' & orig_purp == 'work', 'at work', tour_purp)) %>%
  
  # if still left and work before or after the trip, assume work tour
  mutate(tour_purp = ifelse(tour_purp == 'missing' & at_work_after_dest_purp == 'at work after surveyed trip' & at_work_prior_to_orig_purp == 'at work before surveyed trip', 'work', tour_purp)) %>%
  
  # if still left and home is one end, chose the other as the purpose
  mutate(tour_purp = ifelse(tour_purp == 'missing' & orig_purp == 'home', dest_purp, tour_purp)) %>%
  mutate(tour_purp = ifelse(tour_purp == 'missing' & dest_purp == 'home', orig_purp, tour_purp)) %>%
  
  # if still left, pick the orig_purp
  mutate(tour_purp = ifelse(tour_purp == 'missing', orig_purp, tour_purp))
           
table(survey.standard$tour_purp)


# Step 3:  Update Key locations
# -------------------------------------------------------------------------------------

# Home
survey.standard <- survey.standard %>%
  mutate(home_lat = ifelse(orig_purp == 'home' & is.na(home_lat), orig_lat, home_lat)) %>%
  mutate(home_lon = ifelse(orig_purp == 'home' & is.na(home_lon), orig_lon, home_lon)) %>%
  mutate(home_lat = ifelse(dest_purp == 'home' & is.na(home_lat), dest_lat, home_lat)) %>%
  mutate(home_lon = ifelse(dest_purp == 'home' & is.na(home_lon), dest_lon, home_lon)) %>%
  
# Work
  mutate(workplace_lat = ifelse(orig_purp == 'work' & is.na(workplace_lat), orig_lat, workplace_lat)) %>%
  mutate(workplace_lon = ifelse(orig_purp == 'work' & is.na(workplace_lon), orig_lon, workplace_lon)) %>%
  mutate(workplace_lat = ifelse(dest_purp == 'work' & is.na(workplace_lat), dest_lat, workplace_lat)) %>%
  mutate(workplace_lon = ifelse(dest_purp == 'work' & is.na(workplace_lon), dest_lon, workplace_lon)) %>%
  
# School
  mutate(school_lat = ifelse((orig_purp == 'grade school' | orig_purp == 'high school' | orig_purp == 'college') & is.na(school_lat), orig_lat, school_lat)) %>%
  mutate(school_lon = ifelse((orig_purp == 'grade school' | orig_purp == 'high school' | orig_purp == 'college') & is.na(school_lon), orig_lon, school_lon)) %>%
  mutate(school_lat = ifelse((dest_purp == 'grade school' | dest_purp == 'high school' | dest_purp == 'college') & is.na(school_lat), dest_lat, school_lat)) %>%
  mutate(school_lon = ifelse((dest_purp == 'grade school' | dest_purp == 'high school' | dest_purp == 'college') & is.na(school_lon), dest_lon, school_lon)) 
  

# Step 4:  Automobile Sufficiency
# -------------------------------------------------------------------------------------

# Transform vehicles and workers to standard scale
survey.standard <- survey.standard %>%
  mutate(vehicles = ifelse(vehicles == 'other', vehicles_additional_info, vehicles)) %>%
  mutate(workers  = ifelse(workers  == 'other', workers_additional_info,  workers ))

table(survey.standard$vehicles)
table(survey.standard$workers)

vehicles.dictionary <- data.frame(vehicles = c('zero', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine', 'ten', 'eleven', 'twelve', 'four or more'), vehicle_numeric_cat = c(0, 1, 2, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4))

workers.dictionary <- data.frame(workers = c('zero', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine', 'ten', 'eleven', 'twelve', 'thirteen', 'fourteen', 'fifteen', 'six or more'), worker_numeric_cat = c(0, 1, 2, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4))

survey.standard <- left_join(survey.standard, vehicles.dictionary, by = c("vehicles"))
survey.standard <- left_join(survey.standard, workers.dictionary, by = c("workers"))

survey.standard <- survey.standard %>%
  mutate(auto_suff = ifelse(vehicle_numeric_cat == 0, 'zero autos', 'missing')) %>%
  mutate(auto_suff = ifelse(vehicle_numeric_cat > 0 & worker_numeric_cat > 0  & worker_numeric_cat >  vehicle_numeric_cat, 'auto negotiating', auto_suff)) %>%
  mutate(auto_suff = ifelse(vehicle_numeric_cat > 0 & worker_numeric_cat >= 0 & worker_numeric_cat <= vehicle_numeric_cat, 'auto sufficient', auto_suff))

table(survey.standard$auto_suff)


# Step 5:  Operator and Technology sequence
# -------------------------------------------------------------------------------------

# Set operator for each of six legs (three before, three after)
first_before <- as.data.frame(Set_Operator_Name(survey.standard$first_route_before_survey_board))
colnames(first_before) <- c("first_before_operator")

second_before <- as.data.frame(Set_Operator_Name(survey.standard$second_route_before_survey_board))
colnames(second_before) <- c("second_before_operator")

third_before <- as.data.frame(Set_Operator_Name(survey.standard$third_route_before_survey_board))
colnames(third_before) <- c("third_before_operator")

first_after <- as.data.frame(Set_Operator_Name(survey.standard$first_route_after_survey_alight))
colnames(first_after) <- c("first_after_operator")

second_after <- as.data.frame(Set_Operator_Name(survey.standard$second_route_after_survey_alight))
colnames(second_after) <- c("second_after_operator")

third_after <- as.data.frame(Set_Operator_Name(survey.standard$third_route_after_survey_alight))
colnames(third_after) <- c("third_after_operator")

survey.standard <- cbind(survey.standard, first_before, second_before, third_before, first_after, second_after, third_after)

# Set the technology for each of the six legs
first_before <- as.data.frame(Set_Base_Technology(survey.standard$first_before_operator))
colnames(first_before) <- c("first_before_technology")

second_before <- as.data.frame(Set_Base_Technology(survey.standard$second_before_operator))
colnames(second_before) <- c("second_before_technology")

third_before <- as.data.frame(Set_Base_Technology(survey.standard$third_before_operator))
colnames(third_before) <- c("third_before_technology")

first_after <- as.data.frame(Set_Base_Technology(survey.standard$first_after_operator))
colnames(first_after) <- c("first_after_technology")

second_after <- as.data.frame(Set_Base_Technology(survey.standard$second_after_operator))
colnames(second_after) <- c("second_after_technology")

third_after <- as.data.frame(Set_Base_Technology(survey.standard$third_after_operator))
colnames(third_after) <- c("third_after_technology")

survey.standard <- cbind(survey.standard, first_before, second_before, third_before, first_after, second_after, third_after)

# Update the technology
first_before <- as.data.frame(Update_Technology(survey.standard$first_route_before_survey_board))
colnames(first_before) <- c("first_before_update_tech")

second_before <- as.data.frame(Update_Technology(survey.standard$second_route_before_survey_board))
colnames(second_before) <- c("second_before_update_tech")

third_before <- as.data.frame(Update_Technology(survey.standard$third_route_before_survey_board))
colnames(third_before) <- c("third_before_update_tech")

first_after <- as.data.frame(Update_Technology(survey.standard$first_route_after_survey_alight))
colnames(first_after) <- c("first_after_update_tech")

second_after <- as.data.frame(Update_Technology(survey.standard$second_route_after_survey_alight))
colnames(second_after) <- c("second_after_update_tech")

third_after <- as.data.frame(Update_Technology(survey.standard$third_route_after_survey_alight))
colnames(third_after) <- c("third_after_update_tech")

survey.standard <- cbind(survey.standard, first_before, second_before, third_before, first_after, second_after, third_after)
  
table(survey.standard$first_before_technology)

survey.standard <- survey.standard %>%
  mutate(first_before_technology  = ifelse(first_before_update_tech  != "No Update", as.character(first_before_update_tech),  as.character(first_before_technology))) %>%
  mutate(second_before_technology = ifelse(second_before_update_tech != "No Update", as.character(second_before_update_tech), as.character(second_before_technology))) %>%
  mutate(third_before_technology  = ifelse(third_before_update_tech  != "No Update", as.character(third_before_update_tech),  as.character(third_before_technology))) %>%
  mutate(first_after_technology   = ifelse(first_after_update_tech   != "No Update", as.character(first_after_update_tech),  as.character(first_after_technology))) %>%
  mutate(second_after_technology  = ifelse(second_after_update_tech  != "No Update", as.character(second_after_update_tech),  as.character(second_after_technology))) %>%
  mutate(third_after_technology   = ifelse(third_after_update_tech   != "No Update", as.character(third_after_update_tech),   as.character(third_after_technology)))

table(survey.standard$first_before_technology)


# Step 6:  Travel Model One path details
# -------------------------------------------------------------------------------------

# TODO: Adjust survey technology here if needed

# START HERE AND GET IT WORKING


# Transfer to and from
survey.standard <- survey.standard %>%
  mutate(transfer_from = as.character(first_before_operator)) %>%
  mutate(transfer_from = ifelse(second_before_operator != 'None', as.character(second_before_operator), transfer_from)) %>%
  mutate(transfer_from = ifelse(third_before_operator  != 'None', as.character(third_before_operator),  transfer_from)) %>%
  mutate(transfer_to = as.character(first_after_operator))

# First boarding and last alighting technology
survey.standard <- survey.standard %>%
  mutate(first_transit_tech = as.character(survey_tech)) %>%
  mutate(first_transit_tech = ifelse(first_before_technology != 'None', first_before_technology, first_transit_tech)) %>%
  mutate(last_transit_tech  = as.character(survey_tech)) %>%
  mutate(last_transit_tech = ifelse(first_after_technology  != 'None', first_after_technology, last_transit_tech))  %>%
  mutate(last_transit_tech = ifelse(second_after_technology != 'None', second_after_technology, last_transit_tech)) %>%
  mutate(last_transit_tech = ifelse(third_after_technology  != 'None', third_after_technology, last_transit_tech))

table(survey.standard$transfer_from)
table(survey.standard$transfer_to)
table(survey.standard$survey_tech)
table(survey.standard$first_transit_tech)
table(survey.standard$last_transit_tech)


# Travel Model One path
  
```

### Geocode XY to Travel Model Geographies

### Add Data types

## Bring in Legacy SAS Data set

## Extract Tableau summaries

## Write working set to RData

## Prepare and Write public data set to CSV





