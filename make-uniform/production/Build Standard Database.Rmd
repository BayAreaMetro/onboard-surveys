---
title: "Build Standard Database"
author: "David Ory"
output:
  html_document:
    theme: cosmo
    toc: yes
---

## Administration

#### Purpose
Procedure to translate any number of on-board survey data sets into a single dataset with common variables and common responses.  This is a work-in-progress production version of the procedures.  See ``../mini-example`` and ``../small-example`` for working proto-types.  In this script, we put in place procedures to process surveys into a standard database.  See ``Extract Variables from Legacy Surveys.Rmd`` for procedures to extract variables from legacy surveys (i.e., those with SAS summary scripts). 

#### _ISSUES_
1.  Work carefully through first few datasets, as the code is a bit coarse in places

#### _TODO_

## Overhead

#### Libraries
```{r overhead}
library(knitr)
library(reshape2)
suppressMessages(library(dplyr))
library(stringr)
```

#### Knitr config
```{r config, include=FALSE}
knitr::opts_chunk$set(cache=TRUE)
```

#### Remote file names
```{r file-names}
F_SPATIAL_TO_BE_GEOCODED = "M:/Data/OnBoard/Data and Reports/_geocoding Standardized/spatial_places_to_be_geocoded.csv"
F_BOARD_TO_BE_GEOCODED   = "M:/Data/OnBoard/Data and Reports/_geocoding Standardized/boarding_places_to_be_geocoded.csv"
F_ALIGHT_TO_BE_GEOCODED  = "M:/Data/OnBoard/Data and Reports/_geocoding Standardized/alighting_places_to_be_geocoded.csv"

F_SPATIAL_GEOCODED = "M:/Data/OnBoard/Data and Reports/_geocoding Standardized/spatial_places_geocoded.csv"
F_TRANSIT_GEOCODED = "M:/Data/OnBoard/Data and Reports/_geocoding Standardized/boarding_alighting_places_geocoded.csv"

F_CALTRAIN_SURVEY = "M:/Data/OnBoard/Data and Reports/Caltrain/As CSV/Caltrain_Final_Submitted_1_5_2015_TYPE_WEIGHT_DATE NO POUND OR SINGLE QUOTE.csv"

F_NAPA_SURVEY     = "M:/Data/OnBoard/Data and Reports/Napa Vine/As CSV/Napa Vine Transit OD Survey Data_Dec10_Submitted_toAOK_with_transforms NO POUND OR SINGLE QUOTE.csv"

F_BART_SURVEY = "M:/Data/OnBoard/Data and Reports/BART/As CSV/BART_Final_Database_Mar18_SUBMITTED_with_station_xy NO POUND OR SINGLE QUOTE.csv"

F_MUNI_SURVEY = "M:/Data/OnBoard/Data and Reports/Muni/As CSV/MUNI Pilot Test_Cleaned_08192016_WORKING NO POUND OR SINGLE QUOTE.csv"

F_OUTPUT_RDATA = "M:/Data/OnBoard/Data and Reports/_data Standardized/survey_standard.RData"
F_ANCILLARY_OUTPUT_RDATA = "M:/Data/OnBoard/Data and Reports/_data Standardized/ancillary_variables.RData"
```


## Prepare Dictionaries
```{r prepare-dictionary}
dictionary.all <- read.csv('Dictionary for Standard Database.csv', header = TRUE)

# Prepare seperate dictionaries for categorical and non-categorical variables
dictionary.non <- dictionary.all %>%
  filter(Generic_Response == 'NONCATEGORICAL') %>%
  select(operator, Survey_Variable, Generic_Variable)

dictionary.cat <- dictionary.all %>%
  filter(Generic_Response != 'NONCATEGORICAL') %>%
  mutate(Survey_Response = as.character(Survey_Response))

```

## Operator specifics

### BART
```{r operator-bart}
survey.BAR.key  <- 'BART'
survey.BAR.year <- 2015

# Set survey tech by route if necessary in chunk `combine`
survey.BAR.tech <- 'heavy rail'

# Prepare operator-specific dictionary
dictionary.BAR <- dictionary.all %>%
  filter(operator == survey.BAR.key)

variables.BAR <- as.character(factor(unique(unlist(dictionary.BAR$Survey_Variable, use.names = TRUE))))

# Read data and select variables of interest
survey.BAR <- read.csv(F_BART_SURVEY, header = TRUE)
survey.BAR.select <- survey.BAR[ ,variables.BAR]

# Reshape the data
survey.BAR.melt <- melt(survey.BAR.select, id = 'ID')
survey.BAR.melt <- select(survey.BAR.melt, ID, Survey_Variable = variable, Survey_Response = value)
survey.BAR.melt <- mutate(survey.BAR.melt, operator = survey.BAR.key)
survey.BAR.melt <- mutate(survey.BAR.melt, survey_year = survey.BAR.year)
survey.BAR.melt <- mutate(survey.BAR.melt, survey_tech = survey.BAR.tech)

# Clean up
remove(survey.BAR.key, survey.BAR.year, survey.BAR.tech, dictionary.BAR, variables.BAR, survey.BAR, survey.BAR.select)
```


### Caltrain
```{r operator-caltrain}
survey.CAL.key  <- 'Caltrain'
survey.CAL.year <- 2014

# Set survey tech by route if necessary in chunk `combine`
survey.CAL.tech <- 'commuter rail'

# Prepare operator-specific dictionary
dictionary.CAL <- dictionary.all %>%
  filter(operator == survey.CAL.key)

variables.CAL <- as.character(factor(unique(unlist(dictionary.CAL$Survey_Variable, use.names = TRUE))))

# Read data and select variables of interest
survey.CAL <- read.csv(F_CALTRAIN_SURVEY, header = TRUE)
survey.CAL.select <- survey.CAL[ ,variables.CAL]

# Reshape the data
survey.CAL.melt <- melt(survey.CAL.select, id = 'ID')
survey.CAL.melt <- select(survey.CAL.melt, ID, Survey_Variable = variable, Survey_Response = value)
survey.CAL.melt <- mutate(survey.CAL.melt, operator = survey.CAL.key)
survey.CAL.melt <- mutate(survey.CAL.melt, survey_year = survey.CAL.year)
survey.CAL.melt <- mutate(survey.CAL.melt, survey_tech = survey.CAL.tech)

# Clean up
remove(survey.CAL.key, survey.CAL.year, survey.CAL.tech, dictionary.CAL, variables.CAL, survey.CAL, survey.CAL.select)
```


### Muni
```{r operator-muni}
survey.MUN.key  <- 'SF Muni Pilot'
survey.MUN.year <- 2016

# Set survey tech by route if necessary in chunk `combine`
survey.MUN.tech <- 'local bus'

# Prepare operator-specific dictionary
dictionary.MUN <- dictionary.all %>%
  filter(operator == survey.MUN.key)

variables.MUN <- as.character(factor(unique(unlist(dictionary.MUN$Survey_Variable, use.names = TRUE))))

# Read data and select variables of interest
survey.MUN <- read.csv(F_MUNI_SURVEY, header = TRUE)
survey.MUN.select <- survey.MUN[ ,variables.MUN]

# Reshape the data
survey.MUN.melt <- melt(survey.MUN.select, id = 'ID')
survey.MUN.melt <- select(survey.MUN.melt, ID, Survey_Variable = variable, Survey_Response = value)
survey.MUN.melt <- mutate(survey.MUN.melt, operator = survey.MUN.key)
survey.MUN.melt <- mutate(survey.MUN.melt, survey_year = survey.MUN.year)
survey.MUN.melt <- mutate(survey.MUN.melt, survey_tech = survey.MUN.tech)

# Clean up
remove(survey.MUN.key, survey.MUN.year, survey.MUN.tech, dictionary.MUN, variables.MUN, survey.MUN, survey.MUN.select)
```



### Napa Vine
```{r operator-napa}
survey.NAP.key  <- 'Napa Vine'
survey.NAP.year <- 2014

# Set survey tech by route if necessary in chunk `combine`
survey.NAP.tech <- 'local bus'

# Prepare operator-specific dictionary
dictionary.NAP <- dictionary.all %>%
  filter(operator == survey.NAP.key)

variables.NAP <- as.character(factor(unique(unlist(dictionary.NAP$Survey_Variable, use.names = TRUE))))

# Read data and select variables of interest
survey.NAP <- read.csv(F_NAPA_SURVEY, header = TRUE)
survey.NAP.select <- survey.NAP[ ,variables.NAP]

# Reshape the data
survey.NAP.melt <- melt(survey.NAP.select, id = 'ID')
survey.NAP.melt <- select(survey.NAP.melt, ID, Survey_Variable = variable, Survey_Response = value)
survey.NAP.melt <- mutate(survey.NAP.melt, operator = survey.NAP.key)
survey.NAP.melt <- mutate(survey.NAP.melt, survey_year = survey.NAP.year)
survey.NAP.melt <- mutate(survey.NAP.melt, survey_tech = survey.NAP.tech)

# Clean up
remove(survey.NAP.key, survey.NAP.year, survey.NAP.tech, dictionary.NAP, variables.NAP, survey.NAP, survey.NAP.select)
```

## Combine across operators and flatten
```{r combine}
survey.combine <- rbind(survey.BAR.melt, survey.CAL.melt, survey.MUN.melt, survey.NAP.melt)

# Join the dictionary and prepare the categorical variables
survey.cat <- mutate(survey.combine, Survey_Response = as.character(Survey_Response))
survey.cat <- left_join(survey.cat, dictionary.cat, by = c("operator", "Survey_Variable", "Survey_Response"))
survey.cat <- filter(survey.cat, !is.na(Generic_Variable))

# Join the dictionary and prepare the non-categorical variables
survey.non <- left_join(survey.combine, dictionary.non, by = c("operator", "Survey_Variable"))
survey.non <- survey.non %>%
  filter(!is.na(Generic_Variable)) %>%
  mutate(Generic_Response = Survey_Response)

# Combine the categorical and non-categorical survey data and prepare to flatten
survey.cat.to_flat <- survey.cat %>%
  select(-Survey_Variable, -Survey_Response) %>%
  mutate(Generic_Response = as.factor(Generic_Response))

survey.non.to_flat <- survey.non %>%
  select(-Survey_Variable, -Survey_Response) %>%
  mutate(Generic_Response = as.factor(Generic_Response))

survey.to_flat <- rbind(survey.cat.to_flat, survey.non.to_flat)

# Put together and then take apart a unique ID when flattening
survey.to_flat <- survey.to_flat %>%
  mutate(Unique_ID = paste(ID, operator, survey_year, sep = "---")) %>%
  select(-ID, -operator, -survey_year)

survey.flat <- dcast(survey.to_flat, Unique_ID ~ Generic_Variable, value.var = 'Generic_Response')

survey.flat <- cbind(survey.flat, colsplit(survey.flat$Unique_ID, "---", c("ID", "operator", "survey_year")))

# Add in survey-subject rolling stock technology
survey.adds <- survey.combine %>%
  group_by(ID, operator, survey_year, survey_tech) %>%
  summarise(Count = n()) %>%
  select(-Count)

survey.flat <- left_join(survey.flat, survey.adds, by = c("ID", "operator", "survey_year"))

# Bespoke survey technology
survey.flat <- survey.flat %>%
  mutate(survey_tech = ifelse(operator == "Napa Vine" & (route == 21 | route == 25 | route == 29), "express bus", survey_tech)) %>%
  mutate(survey_tech = ifelse(operator == "SF Muni" & str_count(route, pattern = fixed("E-Emb", ignore_case = TRUE)) > 0L, "light rail", survey_tech)) %>%
  mutate(survey_tech = ifelse(operator == "SF Muni" & str_count(route, pattern = fixed("F-Mar", ignore_case = TRUE)) > 0L, "light rail", survey_tech)) %>%
  mutate(survey_tech = ifelse(operator == "SF Muni" & str_count(route, pattern = fixed("J-Chu", ignore_case = TRUE)) > 0L, "light rail", survey_tech)) %>%
  mutate(survey_tech = ifelse(operator == "SF Muni" & str_count(route, pattern = fixed("KT-Ing", ignore_case = TRUE)) > 0L, "light rail", survey_tech)) %>%
  mutate(survey_tech = ifelse(operator == "SF Muni" & str_count(route, pattern = fixed("L-Tar", ignore_case = TRUE)) > 0L, "light rail", survey_tech)) %>%
  mutate(survey_tech = ifelse(operator == "SF Muni" & str_count(route, pattern = fixed("M-Oce", ignore_case = TRUE)) > 0L, "light rail", survey_tech)) %>%
  mutate(survey_tech = ifelse(operator == "SF Muni" & str_count(route, pattern = fixed("N-Jud", ignore_case = TRUE)) > 0L, "light rail", survey_tech))

remove(dictionary.cat, dictionary.non, survey.cat, survey.non, survey.cat.to_flat, survey.non.to_flat, survey.to_flat, survey.adds)
remove(survey.BAR.melt, survey.CAL.melt, survey.MUN.melt, survey.NAP.melt)

```

## Method Library for Standardization
```{r methods}
# Set Operator Name
Set_Operator_Name <- function(input_vector){
  
  input_df <- as.data.frame(input_vector)
  colnames(input_df) <- c("input_field")
  
  output_df <- input_df %>%
    mutate(output_field = ifelse(!is.na(input_field), "None", input_field)) %>%
    
    # BART, AMTRAK, and Caltrain may be named in route names, so do first, then overwrite
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Amtrak", ignore_case = TRUE)) > 0L, "AMTRAK", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("BART", ignore_case = TRUE)) > 0L, "BART", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Caltrain", ignore_case = TRUE)) > 0L, "CALTRAIN", output_field)) %>%
    
    # Transit Agencies
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("AC ", ignore_case = TRUE)) > 0L, "AC TRANSIT", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("ACE", ignore_case = TRUE)) > 0L, "ACE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("AC Transit", ignore_case = TRUE)) > 0L, "AC TRANSIT", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("AirBART", ignore_case = TRUE)) > 0L, "AC TRANSIT", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("AirTrain", ignore_case = TRUE)) > 0L, "BART", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Capitol Corridor", ignore_case = TRUE)) > 0L, "AMTRAK", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("County Connection", ignore_case = TRUE)) > 0L,"COUNTY CONNECTION", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Fairfield and", ignore_case = TRUE)) > 0L,"FAIRFIELD-SUISUN",output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Golden Gate ", ignore_case = TRUE)) > 0L, "GOLDEN GATE TRANSIT", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Golden Gate Tran", ignore_case = TRUE)) > 0L, "GOLDEN GATE TRANSIT", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Golden Gate Ferry", ignore_case = TRUE)) > 0L, "GOLDEN GATE FERRY", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Marin Transit", ignore_case = TRUE)) > 0L, "MARIN TRANSIT", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Muni", ignore_case = TRUE)) > 0L, "MUNI", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Rio Vista Delta Breeze", ignore_case = TRUE)) > 0L, "RIO-VISTA", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("SamTrans", ignore_case = TRUE)) > 0L, "SAMTRANS",  output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Sam Trans", ignore_case = TRUE)) > 0L, "SAMTRANS",  output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Santa Rosa CityBus", ignore_case = TRUE)) > 0L, "SANTA ROSA CITYBUS", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("SF Bay Ferry", ignore_case = TRUE)) > 0L, "SF BAY FERRY", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Soltrans", ignore_case = TRUE)) > 0L, "SOLTRANS", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Tri Delta", ignore_case = TRUE)) > 0L, "TRI-DELTA",  output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Union City", ignore_case = TRUE)) > 0L, "UNION CITY",  output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("WestCAT", ignore_case = TRUE)) > 0L, "WESTCAT",  output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("VINE", ignore_case = TRUE)) > 0L, "NAPA VINE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("VTA", ignore_case = TRUE)) > 0L, "VTA", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("DASH Downtown Area Shuttle", ignore_case = TRUE)) > 0L, "VTA", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Tiburon FERRY Tiburon To Angel Island State Park", ignore_case = TRUE)) > 0L, "BLUE GOLD FERRY", output_field)) %>%
    
    # PRIVATE SHUTTLE
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Stanford", ignore_case = TRUE)) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Commuter shuttle", ignore_case = TRUE)) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Corinthian lines shuttle", ignore_case = TRUE)) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Caltrain- Shuttles Genentech", ignore_case = TRUE)) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Kaiser shuttle", ignore_case = TRUE)) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("San Jose airport shuttle", ignore_case = TRUE)) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("American Canyon Safeway", ignore_case = TRUE)) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Shuttles Broadway - Millbrae", ignore_case = TRUE)) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Genentech Shuttle", ignore_case = TRUE)) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Sierra Point/Brisbane Shuttle", ignore_case = TRUE)) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("San Francisco General Hospital (SFGH) Shuttle", ignore_case = TRUE)) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Seton Medical Center Shuttle", ignore_case = TRUE)) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("UCSF Shuttle", ignore_case = TRUE)) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("CPMC Hospital Shuttle", ignore_case = TRUE)) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("West Berkeley Shuttle", ignore_case = TRUE)) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Highland Hospital Shuttle", ignore_case = TRUE)) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("San Francisco General Hospital (SFGH) Shuttle", ignore_case = TRUE)) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Seton Medical Center Shuttle", ignore_case = TRUE)) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Oyster Point Shuttle", ignore_case = TRUE)) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Utah Grand Shuttle", ignore_case = TRUE)) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Childrens Hospital Oakland", ignore_case = TRUE)) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Apple Shuttle", ignore_case = TRUE)) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Facebook Shuttle", ignore_case = TRUE)) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Alta Bates Shuttles", ignore_case = TRUE)) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Harbor Bay Shuttle", ignore_case = TRUE)) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Alameda County employee shuttle", ignore_case = TRUE)) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("San Leandro LINKS", ignore_case = TRUE)) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("North Burlingame shuttle", ignore_case = TRUE)) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Fairmont Hospital / Juvenile Justice Shuttle", ignore_case = TRUE)) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Yahoo Shuttle", ignore_case = TRUE)) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Bayhill Shuttle", ignore_case = TRUE)) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Bishop Ranch Shuttle", ignore_case = TRUE)) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    
    # OTHER
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Calistoga Handy Van", ignore_case = TRUE)) > 0L,  "OTHER", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Lake Transit", ignore_case = TRUE)) > 0L,  "OTHER", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Saint Helena Shuttle", ignore_case = TRUE)) > 0L,  "OTHER", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Burlingame Trolley Shuttle", ignore_case = TRUE)) > 0L,  "OTHER", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("SCMTD Highway 17", ignore_case = TRUE)) > 0L,  "OTHER", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Santa Cruz Metro", ignore_case = TRUE)) > 0L,  "OTHER", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Menlo Park Shuttle Midday Shuttle", ignore_case = TRUE)) > 0L,  "OTHER", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Palo Alto E Embarcadero Shuttle", ignore_case = TRUE)) > 0L,  "OTHER", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("CSU East Bay Shuttle", ignore_case = TRUE)) > 0L,  "OTHER", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("UC Berkeley Campus Shuttle", ignore_case = TRUE)) > 0L,  "OTHER", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Shuttle - other or unspecified", ignore_case = TRUE)) > 0L,  "OTHER", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Unknown", ignore_case = TRUE)) > 0L,  "OTHER", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("LBL / Lawrence Berkeley Lab Shuttle", ignore_case = TRUE)) > 0L,  "OTHER", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Agency provided, but route not spec", ignore_case = TRUE)) > 0L,  "OTHER", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("San Francisco State (SFSU) Shuttle", ignore_case = TRUE)) > 0L,  "OTHER", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("PresidiGO", ignore_case = TRUE)) > 0L,  "OTHER", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Emery Go-Round", ignore_case = TRUE)) > 0L,  "OTHER", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("B on Broadway", ignore_case = TRUE)) > 0L,  "OTHER", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Estuary Crossing - College of Alameda Shuttle", ignore_case = TRUE)) > 0L,  "OTHER", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Other", ignore_case = TRUE)) > 0L,  "OTHER", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Monterey-Salinas Transit", ignore_case = TRUE)) > 0L,  "OTHER", output_field)) %>%
    
    # Vague 'Ferry'
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, pattern = fixed("Ferry", ignore_case = TRUE)) > 0L,  "SF BAY FERRY", output_field)) 
  
  return(output_df$output_field)
}

# Set Technology
Set_Base_Technology <- function(input_vector){
  
  operator = c("ACE",               "AC TRANSIT",        "AIR BART",         "AMTRAK",              "BART",             
               "CALTRAIN",          "COUNTY CONNECTION", "FAIRFIELD-SUISUN", "GOLDEN GATE TRANSIT", "GOLDEN GATE FERRY", 
               "MARIN TRANSIT",     "MUNI",              "NAPA VINE",        "RIO-VISTA",           "SAMTRANS",
               "SANTA ROSA CITYBUS","SF BAY FERRY",      "SOLTRANS",          "TRI-DELTA",          "UNION CITY",          
               "WESTCAT",           "VTA",               "OTHER",             "PRIVATE SHUTTLE",  "OTHER AGENCY",        
               "BLUE GOLD FERRY")
  
  technology = c("commuter rail", "local bus", "local bus", "commuter rail", "heavy rail", 
                 "commuter rail", "local bus", "local bus", "express bus",   "ferry",      
                 "local bus",     "local bus", "local bus", "local bus",     "local bus",
                 "local bus",     "ferry",     "local bus", "local bus",     "local bus",     
                 "local bus",     "local bus", "local bus", "local bus",     "local bus",     
                 "ferry")
  
  tech_df <- data.frame(operator, technology)
  tech_df <- tech_df %>%
    mutate(operator = as.character(operator)) %>%
    mutate(technology = as.character(technology))
  
  input_df <- as.data.frame(input_vector)
  colnames(input_df) <- c("operator")
  input_df <- mutate(input_df, operator = as.character(operator))
  
  output_df <- left_join(input_df, tech_df, by = c("operator"))
  
  return(output_df$technology)
}

# Update Technology
Update_Technology <- function(input_vector){
  
  input_df <- as.data.frame(input_vector)
  colnames(input_df) <- c("input_field")
  
  output_df <- input_df %>%
    mutate(output_field = ifelse(!is.na(input_field), "No Update", input_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & 
                                   str_count(input_field, pattern = fixed("Muni", ignore_case = TRUE)) > 0L &
                                   str_count(input_field, pattern = fixed("Light Rail", ignore_case = TRUE)) > 0L, "light rail", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & 
                                   str_count(input_field, pattern = fixed("VTA", ignore_case = TRUE)) > 0L &
                                   str_count(input_field, pattern = fixed("Light Rail", ignore_case = TRUE)) > 0L, "light rail", output_field))
  
  return(output_df$output_field)
}

```


## Build Standard variables
```{r standard-variables-part1}
# Step 1:  Age-related transformations
# -------------------------------------------------------------------------------------

# Standardize year born
survey.standard <- survey.flat %>%
  mutate(year_born = as.numeric(year_born_four_digit)) %>%
  select(-year_born_four_digit)

# Manual fixes to year born
survey.standard <- survey.standard %>%
  mutate(year_born = ifelse(year_born == 1900, 2000, year_born)) %>%
  mutate(year_born = ifelse(year_born == 1901, 2001, year_born)) %>%
  mutate(year_born = ifelse(year_born == 3884, 1984, year_born)) %>%
  mutate(year_born = ifelse(year_born == 2014, NA, year_born)) %>%
  mutate(year_born = ifelse(year_born == 1899, NA, year_born))

table(survey.standard$year_born)

# Compute approximate respondent age 
survey.standard <- survey.standard %>%
  mutate(approximate_age = survey_year - year_born)

table(survey.standard$approximate_age)

# Step 2:  Trip- and tour-purpose-related transformations
# -------------------------------------------------------------------------------------

# Recode key variables from NA to 'missing'
survey.standard <- survey.standard %>%
  mutate(orig_purp       = ifelse(is.na(orig_purp), 'missing', orig_purp)) %>%
  mutate(dest_purp       = ifelse(is.na(dest_purp), 'missing', dest_purp)) %>%
  mutate(work_status     = ifelse(is.na(work_status), 'missing', work_status)) %>%
  mutate(student_status  = ifelse(is.na(student_status), 'missing', student_status)) %>%
  mutate(approximate_age = ifelse(is.na(approximate_age), 'missing', approximate_age)) %>%
  mutate(at_work_prior_to_orig_purp = ifelse(is.na(at_work_prior_to_orig_purp), 'not relevant', at_work_prior_to_orig_purp)) %>%
  mutate(at_work_after_dest_purp = ifelse(is.na(at_work_after_dest_purp), 'not relevant', at_work_after_dest_purp)) %>%
  mutate(at_school_prior_to_orig_purp = ifelse(is.na(at_school_prior_to_orig_purp), 'not relevant', at_school_prior_to_orig_purp)) %>%
  mutate(at_school_after_dest_purp = ifelse(is.na(at_school_after_dest_purp), 'not relevant', at_school_after_dest_purp))

# Refine school purpose
survey.standard <- survey.standard %>%
  mutate(orig_purp = ifelse(orig_purp == "school", "high school", orig_purp)) %>%
  mutate(orig_purp = ifelse(orig_purp == "school" & approximate_age < 14, "grade_school", orig_purp))

# (Approximate) Tour purpose
survey.standard <- survey.standard %>%
  mutate(tour_purp = 'missing') %>%
  
  # workers -- simple
  mutate(tour_purp = ifelse(tour_purp == 'missing' & orig_purp == 'home' & dest_purp == 'work', 'work', tour_purp)) %>%
  mutate(tour_purp = ifelse(tour_purp == 'missing' & orig_purp == 'work' & dest_purp == 'home', 'work', tour_purp)) %>%
  
  # students -- simple
  mutate(tour_purp = ifelse(tour_purp == 'missing' & (orig_purp == 'grade school' | dest_purp == 'grade school'), 'grade school', tour_purp)) %>%
  mutate(tour_purp = ifelse(tour_purp == 'missing' & (orig_purp == 'high school'  | dest_purp == 'high school'),  'high school', tour_purp)) %>%
  
  # non-working university students
  mutate(tour_purp = ifelse(tour_purp == 'missing' & work_status == 'non-worker' & (orig_purp == 'college'  | dest_purp == 'college'),  'university', tour_purp)) %>%
  
  # non-workers, non-students, home-based travel
  mutate(tour_purp = ifelse(tour_purp == 'missing' & work_status == 'non-worker' & student_status == 'non-student' & orig_purp == 'home', dest_purp, tour_purp)) %>%
  mutate(tour_purp = ifelse(tour_purp == 'missing' & work_status == 'non-worker' & student_status == 'non-student' & dest_purp == 'home', orig_purp, tour_purp)) %>%
  mutate(tour_purp = ifelse(tour_purp == 'missing' & work_status == 'non-worker' & student_status == 'non-student' & orig_purp == dest_purp, orig_purp, tour_purp)) %>%
  
  # non-workers, non-students, non-home-based (which we know from above implementation) escorting travel
  mutate(tour_purp = ifelse(tour_purp == 'missing' & work_status == 'non-worker' & student_status == 'non-student' & (orig_purp == 'escorting' | dest_purp == 'escorting'), 'escorting', tour_purp)) %>%
  
  # university is present, but work is not, then university
  mutate(tour_purp = ifelse(tour_purp == 'missing' & at_work_prior_to_orig_purp == 'not at work before surveyed trip' & at_work_after_dest_purp == 'not at work after surveyed trip' & (orig_purp == 'college' | dest_purp == 'college'), 'university', tour_purp)) %>%
  
  # if work before trip and home after, assume work tour
  mutate(tour_purp = ifelse(tour_purp == 'missing' & at_work_prior_to_orig_purp == 'at work before surveyed trip' & dest_purp == 'home', 'work', tour_purp)) %>%
  
  # if work after trip and home before, assume work tour
   mutate(tour_purp = ifelse(tour_purp == 'missing' & at_work_after_dest_purp == 'at work after surveyed trip' & orig_purp == 'home', 'work', tour_purp)) %>%
  
  # if non-worker, school before trip and home after, over 18, university tour
   mutate(tour_purp = ifelse(tour_purp == 'missing' & work_status == 'non-worker' & at_school_prior_to_orig_purp == 'at school before surveyed trip' & approximate_age > 18 & dest_purp == 'home', 'university', tour_purp)) %>%
  
  # if non-worker, school after trip and home before, over 18, university tour
   mutate(tour_purp = ifelse(tour_purp == 'missing' & work_status == 'non-worker' & at_school_after_dest_purp == 'at school after surveyed trip' & approximate_age > 18 & orig_purp == 'home', 'college', tour_purp)) %>%
  
    # if non-worker, school before trip and home after, 14 to 18, high school tour
   mutate(tour_purp = ifelse(tour_purp == 'missing' & work_status == 'non-worker' & at_school_prior_to_orig_purp == 'at school before surveyed trip' & approximate_age <= 18 & approximate_age >= 14 & dest_purp == 'home', 'high school', tour_purp)) %>%
  
  # if non-worker, school after trip and home before, 14 to 18, high school tour
   mutate(tour_purp = ifelse(tour_purp == 'missing' & work_status == 'non-worker' & at_school_after_dest_purp == 'at school after surveyed trip' & approximate_age <= 18 & approximate_age >= 14 & orig_purp == 'home', 'high school', tour_purp)) %>%
  
  # if no work before or after, but work is a leg, assume a work tour
  mutate(tour_purp = ifelse(tour_purp == 'missing' & at_work_prior_to_orig_purp == 'not at work before surveyed trip' & at_work_after_dest_purp == 'not at work after surveyed trip' & (orig_purp == 'work' | dest_purp == 'work'), 'work', tour_purp)) %>%
  
  # at work tours
  mutate(tour_purp = ifelse(tour_purp == 'missing' & at_work_prior_to_orig_purp == 'at work before surveyed trip' & dest_purp == 'work', 'at work', tour_purp)) %>%
  mutate(tour_purp = ifelse(tour_purp == 'missing' & at_work_after_dest_purp == 'at work after surveyed trip' & orig_purp == 'work', 'at work', tour_purp)) %>%
  
  # if still left and work before or after the trip, assume work tour
  mutate(tour_purp = ifelse(tour_purp == 'missing' & at_work_after_dest_purp == 'at work after surveyed trip' & at_work_prior_to_orig_purp == 'at work before surveyed trip', 'work', tour_purp)) %>%
  
  # if still left and home is one end, chose the other as the purpose
  mutate(tour_purp = ifelse(tour_purp == 'missing' & orig_purp == 'home', dest_purp, tour_purp)) %>%
  mutate(tour_purp = ifelse(tour_purp == 'missing' & dest_purp == 'home', orig_purp, tour_purp)) %>%
  
  # if still left, pick the orig_purp
  mutate(tour_purp = ifelse(tour_purp == 'missing', orig_purp, tour_purp))
           
table(survey.standard$tour_purp)

# Step 3:  Update Key locations and Status Flags
# -------------------------------------------------------------------------------------

# Home
survey.standard <- survey.standard %>%
  mutate(home_lat = ifelse(orig_purp == 'home' & is.na(home_lat), orig_lat, home_lat)) %>%
  mutate(home_lon = ifelse(orig_purp == 'home' & is.na(home_lon), orig_lon, home_lon)) %>%
  mutate(home_lat = ifelse(dest_purp == 'home' & is.na(home_lat), dest_lat, home_lat)) %>%
  mutate(home_lon = ifelse(dest_purp == 'home' & is.na(home_lon), dest_lon, home_lon)) %>%
  
# Work
  mutate(workplace_lat = ifelse(orig_purp == 'work' & is.na(workplace_lat), orig_lat, workplace_lat)) %>%
  mutate(workplace_lon = ifelse(orig_purp == 'work' & is.na(workplace_lon), orig_lon, workplace_lon)) %>%
  mutate(workplace_lat = ifelse(dest_purp == 'work' & is.na(workplace_lat), dest_lat, workplace_lat)) %>%
  mutate(workplace_lon = ifelse(dest_purp == 'work' & is.na(workplace_lon), dest_lon, workplace_lon)) %>%
  
# School
  mutate(school_lat = ifelse((orig_purp == 'grade school' | orig_purp == 'high school' | orig_purp == 'college') & is.na(school_lat), orig_lat, school_lat)) %>%
  mutate(school_lon = ifelse((orig_purp == 'grade school' | orig_purp == 'high school' | orig_purp == 'college') & is.na(school_lon), orig_lon, school_lon)) %>%
  mutate(school_lat = ifelse((dest_purp == 'grade school' | dest_purp == 'high school' | dest_purp == 'college') & is.na(school_lat), dest_lat, school_lat)) %>%
  mutate(school_lon = ifelse((dest_purp == 'grade school' | dest_purp == 'high school' | dest_purp == 'college') & is.na(school_lon), dest_lon, school_lon)) 
  
# Work and Student status
survey.standard <- survey.standard %>%
  mutate(work_status = ifelse(orig_purp == 'work' | dest_purp == 'work', 'full- or part-time', work_status)) %>%
  mutate(student_status = ifelse(orig_purp == 'grade school' | dest_purp == 'grade school', 'full- or part-time', student_status)) %>%
  mutate(student_status = ifelse(orig_purp == 'high school'  | dest_purp == 'high school',  'full- or part-time', student_status)) %>%
  mutate(student_status = ifelse(orig_purp == 'college'      | dest_purp == 'college',      'full- or part-time', student_status))

# Step 4:  Automobile Sufficiency
# -------------------------------------------------------------------------------------

# Transform vehicles and workers to standard scale
survey.standard <- survey.standard %>%
  mutate(vehicles = ifelse(vehicles == 'other', vehicles_additional_info, vehicles)) %>%
  mutate(workers  = ifelse(workers  == 'other', workers_additional_info,  workers ))

table(survey.standard$vehicles)
table(survey.standard$workers)

vehicles.dictionary <- data.frame(vehicles = c('zero', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine', 'ten', 'eleven', 'twelve', 'four or more'), vehicle_numeric_cat = c(0, 1, 2, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4))

workers.dictionary <- data.frame(workers = c('zero', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine', 'ten', 'eleven', 'twelve', 'thirteen', 'fourteen', 'fifteen', 'six or more'), worker_numeric_cat = c(0, 1, 2, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4))

survey.standard <- left_join(survey.standard, vehicles.dictionary, by = c("vehicles"))
survey.standard <- left_join(survey.standard, workers.dictionary, by = c("workers"))

survey.standard <- survey.standard %>%
  mutate(auto_suff = ifelse(vehicle_numeric_cat == 0, 'zero autos', 'missing')) %>%
  mutate(auto_suff = ifelse(vehicle_numeric_cat > 0 & worker_numeric_cat > 0  & worker_numeric_cat >  vehicle_numeric_cat, 'auto negotiating', auto_suff)) %>%
  mutate(auto_suff = ifelse(vehicle_numeric_cat > 0 & worker_numeric_cat >= 0 & worker_numeric_cat <= vehicle_numeric_cat, 'auto sufficient', auto_suff))

table(survey.standard$auto_suff)

remove(vehicles.dictionary, workers.dictionary)


# Step 5:  Operator and Technology sequence
# -------------------------------------------------------------------------------------

# Set operator for each of six legs (three before, three after)
# - remove BART 'Missing - Dummy Record' before starting
survey.standard <- survey.standard %>%
  mutate(first_route_before_survey_board = 
           ifelse(first_route_before_survey_board == "Missing - Dummy Record", "", first_route_before_survey_board)) %>%
    mutate(second_route_before_survey_board = 
           ifelse(second_route_before_survey_board == "Missing - Dummy Record", "", second_route_before_survey_board)) %>%
    mutate(third_route_before_survey_board = 
           ifelse(third_route_before_survey_board == "Missing - Dummy Record", "", third_route_before_survey_board))

survey.standard <- survey.standard %>%
  mutate(first_route_after_survey_alight = 
           ifelse(first_route_after_survey_alight == "Missing - Dummy Record", "", first_route_after_survey_alight)) %>%
    mutate(second_route_after_survey_alight = 
           ifelse(second_route_after_survey_alight == "Missing - Dummy Record", "", second_route_after_survey_alight)) %>%
    mutate(third_route_after_survey_alight = 
           ifelse(third_route_after_survey_alight == "Missing - Dummy Record", "", third_route_after_survey_alight))

first_before <- as.data.frame(Set_Operator_Name(survey.standard$first_route_before_survey_board))
colnames(first_before) <- c("first_before_operator")

second_before <- as.data.frame(Set_Operator_Name(survey.standard$second_route_before_survey_board))
colnames(second_before) <- c("second_before_operator")

third_before <- as.data.frame(Set_Operator_Name(survey.standard$third_route_before_survey_board))
colnames(third_before) <- c("third_before_operator")

first_after <- as.data.frame(Set_Operator_Name(survey.standard$first_route_after_survey_alight))
colnames(first_after) <- c("first_after_operator")

second_after <- as.data.frame(Set_Operator_Name(survey.standard$second_route_after_survey_alight))
colnames(second_after) <- c("second_after_operator")

third_after <- as.data.frame(Set_Operator_Name(survey.standard$third_route_after_survey_alight))
colnames(third_after) <- c("third_after_operator")

survey.standard <- cbind(survey.standard, first_before, second_before, third_before, first_after, second_after, third_after)

# Set the technology for each of the six legs
first_before <- as.data.frame(Set_Base_Technology(survey.standard$first_before_operator))
colnames(first_before) <- c("first_before_technology")

second_before <- as.data.frame(Set_Base_Technology(survey.standard$second_before_operator))
colnames(second_before) <- c("second_before_technology")

third_before <- as.data.frame(Set_Base_Technology(survey.standard$third_before_operator))
colnames(third_before) <- c("third_before_technology")

first_after <- as.data.frame(Set_Base_Technology(survey.standard$first_after_operator))
colnames(first_after) <- c("first_after_technology")

second_after <- as.data.frame(Set_Base_Technology(survey.standard$second_after_operator))
colnames(second_after) <- c("second_after_technology")

third_after <- as.data.frame(Set_Base_Technology(survey.standard$third_after_operator))
colnames(third_after) <- c("third_after_technology")

survey.standard <- cbind(survey.standard, first_before, second_before, third_before, first_after, second_after, third_after)

# Update the technology
first_before <- as.data.frame(Update_Technology(survey.standard$first_route_before_survey_board))
colnames(first_before) <- c("first_before_update_tech")

second_before <- as.data.frame(Update_Technology(survey.standard$second_route_before_survey_board))
colnames(second_before) <- c("second_before_update_tech")

third_before <- as.data.frame(Update_Technology(survey.standard$third_route_before_survey_board))
colnames(third_before) <- c("third_before_update_tech")

first_after <- as.data.frame(Update_Technology(survey.standard$first_route_after_survey_alight))
colnames(first_after) <- c("first_after_update_tech")

second_after <- as.data.frame(Update_Technology(survey.standard$second_route_after_survey_alight))
colnames(second_after) <- c("second_after_update_tech")

third_after <- as.data.frame(Update_Technology(survey.standard$third_route_after_survey_alight))
colnames(third_after) <- c("third_after_update_tech")

survey.standard <- cbind(survey.standard, first_before, second_before, third_before, first_after, second_after, third_after)
  
table(survey.standard$first_before_technology)

survey.standard <- survey.standard %>%
  mutate(first_before_technology  = ifelse(first_before_update_tech  != "No Update", as.character(first_before_update_tech),  as.character(first_before_technology))) %>%
  mutate(second_before_technology = ifelse(second_before_update_tech != "No Update", as.character(second_before_update_tech), as.character(second_before_technology))) %>%
  mutate(third_before_technology  = ifelse(third_before_update_tech  != "No Update", as.character(third_before_update_tech),  as.character(third_before_technology))) %>%
  mutate(first_after_technology   = ifelse(first_after_update_tech   != "No Update", as.character(first_after_update_tech),  as.character(first_after_technology))) %>%
  mutate(second_after_technology  = ifelse(second_after_update_tech  != "No Update", as.character(second_after_update_tech),  as.character(second_after_technology))) %>%
  mutate(third_after_technology   = ifelse(third_after_update_tech   != "No Update", as.character(third_after_update_tech),   as.character(third_after_technology)))

table(survey.standard$first_before_technology)

# Clean up
remove(first_before, second_before, third_before, first_after, second_after, third_after)
survey.standard <- survey.standard %>%
  select(-first_before_update_tech, -second_before_update_tech, -third_before_update_tech, -first_after_update_tech, -second_after_update_tech, -third_after_update_tech)


# Step 6:  Travel Model One path details
# -------------------------------------------------------------------------------------

# Transfer to and from
survey.standard <- survey.standard %>%
  mutate(transfer_from = as.character(first_before_operator)) %>%
  mutate(transfer_from = ifelse(second_before_operator != 'None', as.character(second_before_operator), transfer_from)) %>%
  mutate(transfer_from = ifelse(third_before_operator  != 'None', as.character(third_before_operator),  transfer_from)) %>%
  mutate(transfer_to = as.character(first_after_operator))

# First boarding and last alighting technology
survey.standard <- survey.standard %>%
  mutate(first_board_tech = as.character(survey_tech)) %>%
  mutate(first_board_tech = ifelse(!is.na(first_before_technology), first_before_technology, first_board_tech)) %>%
  mutate(last_alight_tech  = as.character(survey_tech)) %>%
  mutate(last_alight_tech = ifelse(!is.na(first_after_technology),  first_after_technology,  last_alight_tech)) %>%
  mutate(last_alight_tech = ifelse(!is.na(second_after_technology), second_after_technology, last_alight_tech)) %>%
  mutate(last_alight_tech = ifelse(!is.na(third_after_technology),  third_after_technology,  last_alight_tech))

table(survey.standard$transfer_from)
table(survey.standard$transfer_to)
table(survey.standard$survey_tech)
table(survey.standard$first_board_tech)
table(survey.standard$last_alight_tech)

# Travel Model One path (re-write to acknowledge NA explicitly)
# -- Access
survey.standard <- survey.standard %>%
  mutate(path_access = "X") %>%
  mutate(path_access = ifelse(access_mode == "walk", "W", path_access)) %>%
  mutate(path_access = ifelse(access_mode == "pnr" , "D", path_access)) %>%
  mutate(path_access = ifelse(access_mode == "knr" , "D", path_access)) %>%
  mutate(path_access = ifelse(access_mode == "bike", "D", path_access)) %>%
  mutate(path_access = ifelse(is.na(access_mode), "X", path_access))

table(survey.standard$path_access)

# -- Egress
survey.standard <- survey.standard %>%
  mutate(path_egress = "X") %>%
  mutate(path_egress = ifelse(egress_mode == "walk", "W", path_egress)) %>%
  mutate(path_egress = ifelse(egress_mode == "pnr" , "D", path_egress)) %>%
  mutate(path_egress = ifelse(egress_mode == "knr" , "D", path_egress)) %>%
  mutate(path_egress = ifelse(egress_mode == "bike", "D", path_egress)) %>%
  mutate(path_egress = ifelse(is.na(egress_mode), "X", path_egress))

table(survey.standard$path_egress)

# -- Line haul
# --- Technology present calculations
survey.standard <- survey.standard %>%
  mutate(first_before_technology  = ifelse(is.na(first_before_technology),  "Missing", first_before_technology)) %>%
  mutate(second_before_technology = ifelse(is.na(second_before_technology), "Missing", second_before_technology)) %>%
  mutate(third_before_technology  = ifelse(is.na(third_before_technology),  "Missing", third_before_technology)) %>%
  mutate(first_after_technology   = ifelse(is.na(first_after_technology),   "Missing", first_after_technology)) %>%
  mutate(second_after_technology  = ifelse(is.na(second_after_technology),  "Missing", second_after_technology)) %>%
  mutate(third_after_technology   = ifelse(is.na(third_after_technology),   "Missing", third_after_technology))

survey.standard <- survey.standard %>%
  mutate(commuter_rail_present = FALSE) %>%
  mutate(commuter_rail_present = ifelse(first_before_technology  == "commuter rail", TRUE, commuter_rail_present)) %>%
  mutate(commuter_rail_present = ifelse(second_before_technology == "commuter rail", TRUE, commuter_rail_present)) %>%
  mutate(commuter_rail_present = ifelse(third_before_technology  == "commuter rail", TRUE, commuter_rail_present)) %>%
  mutate(commuter_rail_present = ifelse(survey_tech              == "commuter rail", TRUE, commuter_rail_present)) %>%
  mutate(commuter_rail_present = ifelse(first_after_technology   == "commuter rail", TRUE, commuter_rail_present)) %>%
  mutate(commuter_rail_present = ifelse(second_after_technology  == "commuter rail", TRUE, commuter_rail_present)) %>%
  mutate(commuter_rail_present = ifelse(third_after_technology   == "commuter rail", TRUE, commuter_rail_present))

table(survey.standard$commuter_rail_present)

survey.standard <- survey.standard %>%
  mutate(heavy_rail_present = FALSE) %>%
  mutate(heavy_rail_present = ifelse(first_before_technology  == "heavy rail", TRUE, heavy_rail_present)) %>%
  mutate(heavy_rail_present = ifelse(second_before_technology == "heavy rail", TRUE, heavy_rail_present)) %>%
  mutate(heavy_rail_present = ifelse(third_before_technology  == "heavy rail", TRUE, heavy_rail_present)) %>%
  mutate(heavy_rail_present = ifelse(survey_tech              == "heavy rail", TRUE, heavy_rail_present)) %>%
  mutate(heavy_rail_present = ifelse(first_after_technology   == "heavy rail", TRUE, heavy_rail_present)) %>%
  mutate(heavy_rail_present = ifelse(second_after_technology  == "heavy rail", TRUE, heavy_rail_present)) %>%
  mutate(heavy_rail_present = ifelse(third_after_technology   == "heavy rail", TRUE, heavy_rail_present))

table(survey.standard$heavy_rail_present)

survey.standard <- survey.standard %>%
  mutate(express_bus_present = FALSE) %>%
  mutate(express_bus_present = ifelse(first_before_technology  == "express bus", TRUE, express_bus_present)) %>%
  mutate(express_bus_present = ifelse(second_before_technology == "express bus", TRUE, express_bus_present)) %>%
  mutate(express_bus_present = ifelse(third_before_technology  == "express bus", TRUE, express_bus_present)) %>%
  mutate(express_bus_present = ifelse(survey_tech              == "express bus", TRUE, express_bus_present)) %>%
  mutate(express_bus_present = ifelse(first_after_technology   == "express bus", TRUE, express_bus_present)) %>%
  mutate(express_bus_present = ifelse(second_after_technology  == "express bus", TRUE, express_bus_present)) %>%
  mutate(express_bus_present = ifelse(third_after_technology   == "express bus", TRUE, express_bus_present))

table(survey.standard$express_bus_present)

survey.standard <- survey.standard %>%
  mutate(ferry_present = FALSE) %>%
  mutate(ferry_present = ifelse(first_before_technology  == "ferry", TRUE, ferry_present)) %>%
  mutate(ferry_present = ifelse(second_before_technology == "ferry", TRUE, ferry_present)) %>%
  mutate(ferry_present = ifelse(third_before_technology  == "ferry", TRUE, ferry_present)) %>%
  mutate(ferry_present = ifelse(survey_tech              == "ferry", TRUE, ferry_present)) %>%
  mutate(ferry_present = ifelse(first_after_technology   == "ferry", TRUE, ferry_present)) %>%
  mutate(ferry_present = ifelse(second_after_technology  == "ferry", TRUE, ferry_present)) %>%
  mutate(ferry_present = ifelse(third_after_technology   == "ferry", TRUE, ferry_present))

table(survey.standard$ferry_present)

survey.standard <- survey.standard %>%
  mutate(light_rail_present = FALSE) %>%
  mutate(light_rail_present = ifelse(first_before_technology  == "light rail", TRUE, light_rail_present)) %>%
  mutate(light_rail_present = ifelse(second_before_technology == "light rail", TRUE, light_rail_present)) %>%
  mutate(light_rail_present = ifelse(third_before_technology  == "light rail", TRUE, light_rail_present)) %>%
  mutate(light_rail_present = ifelse(survey_tech              == "light rail", TRUE, light_rail_present)) %>%
  mutate(light_rail_present = ifelse(first_after_technology   == "light rail", TRUE, light_rail_present)) %>%
  mutate(light_rail_present = ifelse(second_after_technology  == "light rail", TRUE, light_rail_present)) %>%
  mutate(light_rail_present = ifelse(third_after_technology   == "light rail", TRUE, light_rail_present))

table(survey.standard$light_rail_present)

survey.standard <- survey.standard %>%
  mutate(path_line_haul = "LOC") %>%
  mutate(path_line_haul = ifelse(light_rail_present,    "LRF", path_line_haul)) %>%
  mutate(path_line_haul = ifelse(ferry_present,         "LRF", path_line_haul)) %>%
  mutate(path_line_haul = ifelse(express_bus_present,   "EXP", path_line_haul)) %>%
  mutate(path_line_haul = ifelse(heavy_rail_present,    "HVY", path_line_haul)) %>%
  mutate(path_line_haul = ifelse(commuter_rail_present, "COM", path_line_haul)) %>%
  mutate(path_label = paste(path_access, path_line_haul, path_egress, sep = "-"))

table(survey.standard$path_label)
           
# Boardings
survey.standard <- survey.standard %>%
  mutate(boardings = 1L) %>%
  mutate(boardings = ifelse(!(first_before_technology  == "Missing"), boardings + 1, boardings)) %>%
  mutate(boardings = ifelse(!(second_before_technology == "Missing"), boardings + 1, boardings)) %>%
  mutate(boardings = ifelse(!(third_before_technology  == "Missing"), boardings + 1, boardings)) %>%
  mutate(boardings = ifelse(!(first_after_technology   == "Missing"), boardings + 1, boardings)) %>%
  mutate(boardings = ifelse(!(second_after_technology  == "Missing"), boardings + 1, boardings)) %>%
  mutate(boardings = ifelse(!(third_after_technology   == "Missing"), boardings + 1, boardings))

table(survey.standard$boardings)

# If missing, compute number_transfers_orig_board and number_transfers_alight_dest
survey.standard <- survey.standard %>%
  mutate(first  = ifelse(str_length(first_route_before_survey_board)  == 0L, 0, 1)) %>%
  mutate(second = ifelse(str_length(second_route_before_survey_board) == 0L, 0, 1)) %>%
  mutate(third  = ifelse(str_length(third_route_before_survey_board)  == 0L, 0, 1)) %>%
  mutate(number_transfers_orig_board = ifelse(is.na(number_transfers_orig_board), 
         first + second + third, number_transfers_orig_board)) %>%
  mutate(first  = ifelse(str_length(first_route_after_survey_alight)  == 0L, 0, 1)) %>%
  mutate(second = ifelse(str_length(second_route_after_survey_alight) == 0L, 0, 1)) %>%
  mutate(third  = ifelse(str_length(third_route_after_survey_alight)  == 0L, 0, 1)) %>%
  mutate(number_transfers_alight_dest = ifelse(is.na(number_transfers_alight_dest), 
         first + second + third, number_transfers_alight_dest)) %>%
  select(-first, -second, -third)

table(survey.standard$number_transfers_orig_board)
table(survey.standard$number_transfers_alight_dest)

survey.standard <- survey.standard %>%
  mutate(survey_boardings = 1L + as.numeric(number_transfers_orig_board) + as.numeric(number_transfers_alight_dest))

table(survey.standard$boardings, survey.standard$survey_boardings)

# Build debug data frame to find odds and ends
debug.transfers <- survey.standard %>%
  filter(!(boardings == survey_boardings)) %>%
  select(ID, operator,
         boardings, survey_boardings,
         first_route_before_survey_board,  first_before_operator,  first_before_technology,
         second_route_before_survey_board, second_before_operator, second_before_technology,
         third_route_before_survey_board,  third_before_operator,  third_before_technology,
         first_route_after_survey_alight,   first_after_operator,  first_after_technology,
         second_route_after_survey_alight, second_after_operator, second_after_technology,
         third_route_after_survey_alight,  third_after_operator,  third_after_technology)

survey.standard <- survey.standard %>%
  select(-survey_boardings, -commuter_rail_present, -heavy_rail_present, -ferry_present, 
         -light_rail_present, -express_bus_present)

```


``` {r standard-variables-part2}
# Step 7:  Standardize Demographics
# -------------------------------------------------------------------------------------
survey.standard <- survey.standard %>%
  
  # Race
  mutate(race_dmy_ind = as.numeric(race_dmy_ind)) %>%
  mutate(race_dmy_asn = as.numeric(race_dmy_asn)) %>%
  mutate(race_dmy_blk = as.numeric(race_dmy_blk)) %>%
  mutate(race_dmy_hwi = as.numeric(race_dmy_hwi)) %>%
  mutate(race_dmy_wht = as.numeric(race_dmy_wht)) %>%
  
  mutate(race_dmy_oth = ifelse(str_length(as.character(race_other_string)) > 2, 1L, 0L)) %>%
  mutate(race_dmy_sum = race_dmy_ind + race_dmy_asn + race_dmy_blk + race_dmy_hwi + race_dmy_wht + race_dmy_oth) %>%
  
  mutate(race = 'OTHER') %>%
  mutate(race = ifelse(race_dmy_sum == 1 & race_dmy_ind == 1, 'OTHER', race)) %>%
  mutate(race = ifelse(race_dmy_sum == 1 & race_dmy_asn == 1, 'ASIAN', race)) %>%
  mutate(race = ifelse(race_dmy_sum == 1 & race_dmy_blk == 1, 'BLACK', race)) %>%
  mutate(race = ifelse(race_dmy_sum == 1 & race_dmy_hwi == 1, 'OTHER', race)) %>%
  mutate(race = ifelse(race_dmy_sum == 1 & race_dmy_wht == 1, 'WHITE', race)) %>%
  mutate(race = ifelse(race_dmy_sum == 1 & race_dmy_oth == 1, 'OTHER', race)) %>%
  
  # Language at home
  mutate(language_at_home = ifelse(as.character(language_at_home_binary) == 'OTHER', as.character(language_at_home_detail), as.character(language_at_home_binary))) %>%
  select(-language_at_home_binary, -language_at_home_detail, -race_dmy_ind, -race_dmy_asn, -race_dmy_blk, -race_dmy_hwi, -race_dmy_wht, -race_dmy_oth, -race_dmy_sum, -race_other_string)

# Update fare medium for surveys with clipper detail
survey.standard <- survey.standard %>%
  mutate(fare_medium = ifelse(is.na(clipper_detail), fare_medium, clipper_detail)) %>%
  select(-clipper_detail)

table(survey.standard$work_status)
table(survey.standard$student_status)
table(survey.standard$fare_medium)
table(survey.standard$fare_category)
table(survey.standard$hispanic)
table(survey.standard$race)
table(survey.standard$language_at_home)
table(survey.standard$household_income)
table(survey.standard$eng_proficient)
  
# Step 8:  Create route if needed, set dates and times
# -------------------------------------------------------------------------------------

# Build route from entry and exit station, as needed
survey.standard <- survey.standard %>%
  mutate(route = ifelse(!is.na(onoff_enter_station), paste(onoff_enter_station, onoff_exit_station, sep = " "), route))

# Deal with date and time
survey.standard <- survey.standard %>%
  mutate(date_string = ifelse(str_length(date_string) == 0, NA, date_string)) %>%
  mutate(time_string = ifelse(str_length(time_string) == 0, NA, time_string))

# Deal with BART's missing (currently only have weekday data, update when we add in weekend)
survey.standard <- survey.standard %>%
  mutate(date_string = ifelse(date_string == "Missing - Dummy Record", NA, date_string)) %>%
  mutate(date_string = ifelse(date_string == "Missing - Question Not Asked", NA, date_string)) %>%
  mutate(weekpart = ifelse(is.na(date_string), "WEEKDAY", weekpart))

#table(survey.standard$date_string)
#table(survey.standard$time_string)

# Get day of the week from date
survey.standard <- survey.standard %>%
  mutate(date = as.Date(date_string, format = "%m/%d/%Y")) %>%
  mutate(day_of_the_week = toupper(weekdays(date)))

table(survey.standard$operator, survey.standard$day_of_the_week)

# Fill in missing weekpart
survey.standard <- survey.standard %>%
  mutate(weekpart = ifelse(is.na(weekpart) & day_of_the_week == "SUNDAY",   "WEEKEND", weekpart)) %>%
  mutate(weekpart = ifelse(is.na(weekpart) & day_of_the_week == "MONDAY",   "WEEKDAY", weekpart)) %>%
  mutate(weekpart = ifelse(is.na(weekpart) & day_of_the_week == "TUESDAY",  "WEEKDAY", weekpart)) %>%
  mutate(weekpart = ifelse(is.na(weekpart) & day_of_the_week == "WEDNESDAY","WEEKDAY", weekpart)) %>%
  mutate(weekpart = ifelse(is.na(weekpart) & day_of_the_week == "THURSDAY", "WEEKDAY", weekpart)) %>%
  mutate(weekpart = ifelse(is.na(weekpart) & day_of_the_week == "FRIDAY",   "WEEKDAY", weekpart)) %>%
  mutate(weekpart = ifelse(is.na(weekpart) & day_of_the_week == "SATURDAY", "WEEKEND", weekpart))

table(survey.standard$operator,survey.standard$weekpart)

# Get field dates from date
field.dates <- survey.standard %>%
  group_by(operator, survey_year) %>%
  filter(!is.na(date)) %>%
  summarise(field_start = min(date), field_end = max(date))

survey.standard <- left_join(survey.standard, field.dates, by = c("operator", "survey_year"))

# Deal with time
survey.standard <- survey.standard %>%
  mutate(time_string = ifelse(time_string == "Missing - Dummy Record", NA, time_string)) %>%
  mutate(time_string = ifelse(time_string == "Missing - Question Not Asked", NA, time_string)) %>%
  mutate(am_pm = str_trim(str_sub(time_string, -2, -1))) %>%
  mutate(raw_hour = str_sub(time_string, 1, 2)) %>%
  mutate(hour = as.numeric(gsub("[:,]", "", raw_hour))) %>%
  mutate(time_start = ifelse(am_pm == "PM" & hour < 12, hour + 12, ifelse(am_pm == "AM" & hour == 12, 0, hour))) %>%
  mutate(day_part = 'EVENING') %>%
  mutate(day_part = ifelse(time_start > 2  & time_start < 6,  'EARLY AM', day_part)) %>%
  mutate(day_part = ifelse(time_start > 5  & time_start < 11, 'AM PEAK' , day_part)) %>%
  mutate(day_part = ifelse(time_start > 10 & time_start < 15, 'MIDDAY'  , day_part)) %>%
  mutate(day_part = ifelse(time_start > 14 & time_start < 19, 'PM PEAK' , day_part))

table(survey.standard$field_start)
table(survey.standard$field_end)
table(survey.standard$time_start)
table(survey.standard$day_part)
table(survey.standard$day_of_the_week)

survey.standard <- survey.standard %>%
  select(-date_string, -time_string, -am_pm, -raw_hour, -hour)

```

### Geocode XY to Travel Model Geographies 
(see `../geocode-engine` for tools)
```{r geocode-doit}
# Prepare and write locations that need to be geo-coded to disk
temp_lat <- survey.standard %>%
  select(Unique_ID, dest = dest_lat, home = home_lat, orig = orig_lat, school = school_lat, workplace = workplace_lat)

temp_lon <- survey.standard %>%
  select(Unique_ID, dest = dest_lon, home = home_lon, orig = orig_lon, school = school_lon, workplace = workplace_lon)

temp_lat.melt <- melt(temp_lat, id = 'Unique_ID')
temp_lon.melt <- melt(temp_lon, id = 'Unique_ID')

temp_lat.melt <- temp_lat.melt %>%
  select(Unique_ID, variable, y_coord = value)

temp_lon.melt <- temp_lon.melt %>%
  select(Unique_ID, variable, x_coord = value)

write.places <- left_join(temp_lat.melt, temp_lon.melt, by = c("Unique_ID", "variable"))

write.places <- write.places %>%
  mutate(x_coord = as.numeric(x_coord)) %>%
  mutate(y_coord = as.numeric(y_coord)) %>%
  filter(!is.na(x_coord)) %>%
  filter(!is.na(y_coord))

survey.standard <- survey.standard %>%
  mutate(first_board_lat  = ifelse(number_transfers_orig_board == 0,  survey_board_lat,  first_board_lat)) %>%
  mutate(first_board_lon  = ifelse(number_transfers_orig_board == 0,  survey_board_lon,  first_board_lon)) %>%
  mutate(first_board_tech = ifelse(number_transfers_orig_board == 0,  survey_tech,       first_board_tech)) %>%
  mutate(last_alight_lat  = ifelse(number_transfers_alight_dest == 0, survey_alight_lat, last_alight_lat)) %>%
  mutate(last_alight_lon  = ifelse(number_transfers_alight_dest == 0, survey_alight_lon, last_alight_lon)) %>%
  mutate(last_alight_tech = ifelse(number_transfers_alight_dest == 0, survey_tech,       last_alight_tech))

write.board <- survey.standard %>%
  select(Unique_ID, first_board_lat, first_board_lon, first_board_tech) %>%
  mutate(first_board_lat = as.numeric(first_board_lat)) %>%
  mutate(first_board_lon = as.numeric(first_board_lon)) %>%
  filter(!is.na(first_board_lat)) %>%
  filter(!is.na(first_board_lon))

write.alight <- survey.standard %>%
  select(Unique_ID, last_alight_lat, last_alight_lon, last_alight_tech) %>%
  mutate(last_alight_lat = as.numeric(last_alight_lat)) %>%
  mutate(last_alight_lon = as.numeric(last_alight_lon)) %>%
  filter(!is.na(last_alight_lat)) %>%
  filter(!is.na(last_alight_lon))

write.csv(write.places, file = F_SPATIAL_TO_BE_GEOCODED,  row.names = FALSE, quote = F)
write.csv(write.board,  file = F_BOARD_TO_BE_GEOCODED,    row.names = FALSE, quote = F)
write.csv(write.alight, file = F_ALIGHT_TO_BE_GEOCODED,   row.names = FALSE, quote = F)

remove(temp_lat, temp_lon, temp_lat.melt, temp_lon.melt, write.places, write.board, write.alight)

```

```{r geocode-addit}
# Bring in the geocoding results
geocoded_spatial_places <- read.csv(F_SPATIAL_GEOCODED, header = TRUE)
geocoded_transit_places <- read.csv(F_TRANSIT_GEOCODED, header = TRUE)

geocoded_spatial_places <- select(geocoded_spatial_places, -x_coord, -y_coord)
geo_spatial_maz <- dcast(geocoded_spatial_places, Unique_ID ~ variable, value.var = "MAZ_ORIGINAL")
geo_spatial_maz <- geo_spatial_maz %>%
  select(Unique_ID, dest_maz = dest, home_maz = home, orig_maz = orig, school_maz = school, workplace_maz = workplace) %>%
  mutate(Unique_ID = as.character(Unique_ID))

geo_spatial_taz <- dcast(geocoded_spatial_places, Unique_ID ~ variable, value.var = "TAZ1454")
geo_spatial_taz <- geo_spatial_taz %>%
  select(Unique_ID, dest_taz = dest, home_taz = home, orig_taz = orig, school_taz = school, workplace_taz = workplace) %>%
  mutate(Unique_ID = as.character(Unique_ID))

geo_transit_tap <- geocoded_transit_places %>%
  select(Unique_ID, first_board_tap = board_tap, last_alight_tap = alight_tap) %>%
  mutate(Unique_ID = as.character(Unique_ID))

# Joins
survey.standard <- left_join(survey.standard, geo_spatial_maz, by = c("Unique_ID"))
survey.standard <- left_join(survey.standard, geo_spatial_taz, by = c("Unique_ID"))
survey.standard <- left_join(survey.standard, geo_transit_tap, by = c("Unique_ID"))

remove(geocoded_spatial_places, geocoded_transit_places, geo_spatial_maz, geo_spatial_taz, geo_transit_tap)
```

### Clean up data types
```{r data-types}
# Cast all factors to numeric or string
survey.standard <- survey.standard %>%
  mutate(first_before_operator  = as.character(first_before_operator)) %>%
  mutate(second_before_operator = as.character(second_before_operator)) %>%
  mutate(third_before_operator  = as.character(third_before_operator)) %>%
  mutate(first_after_operator   = as.character(first_after_operator)) %>%
  mutate(second_after_operator  = as.character(second_after_operator)) %>%
  mutate(third_after_operator   = as.character(third_after_operator)) %>%
  mutate(depart_hour            = as.numeric(depart_hour)) %>%
  mutate(return_hour            = as.numeric(return_hour)) %>%
  mutate(survey_board_lat       = as.numeric(survey_board_lat)) %>%
  mutate(survey_board_lon       = as.numeric(survey_board_lon)) %>%
  mutate(survey_alight_lat      = as.numeric(survey_alight_lat)) %>%
  mutate(survey_alight_lon      = as.numeric(survey_alight_lon)) %>%
  mutate(first_board_lat        = as.numeric(first_board_lat)) %>%
  mutate(first_board_lon        = as.numeric(first_board_lon)) %>%
  mutate(last_alight_lat        = as.numeric(last_alight_lat)) %>%
  mutate(last_alight_lon        = as.numeric(last_alight_lon)) %>%
  mutate(weight                 = as.numeric(weight))

# Create an ancillary data set for requested variables
ancillary_df <- survey.standard %>%
  select(Unique_ID, 
         at_school_after_dest_purp, 
         at_school_prior_to_orig_purp, 
         at_work_after_dest_purp, 
         at_work_prior_to_orig_purp)

# Drop variables we don't want to carry forward to standard dataset
survey.standard <- survey.standard %>%
  select(-at_school_after_dest_purp, 
         -at_school_prior_to_orig_purp, 
         -at_work_after_dest_purp, 
         -at_work_prior_to_orig_purp,
         -date,
         -time_start,
         -vehicle_numeric_cat,
         -worker_numeric_cat,
         -year_born,
         -number_transfers_alight_dest,
         -number_transfers_orig_board,
         -first_route_before_survey_board,
         -first_route_after_survey_alight,
         -second_route_before_survey_board,
         -second_route_after_survey_alight,
         -third_route_before_survey_board,
         -third_route_after_survey_alight,
         -first_before_operator,
         -second_before_operator,
         -third_before_operator,
         -first_after_operator,
         -second_after_operator,
         -third_after_operator,
         -first_before_technology,
         -second_before_technology,
         -third_before_technology,
         -first_after_technology,
         -second_after_technology,
         -third_after_technology)

# Drop lat/lon for locations
survey.standard <- survey.standard %>%
  select(-dest_lat,
         -dest_lon,
         -home_lat,
         -home_lon,
         -orig_lat,
         -orig_lon,
         -school_lat,
         -school_lon,
         -workplace_lat,
         -workplace_lon)

```

## Write RData to Disk
```{r disk-write}
# Compute trip weight, replace missing weights with zero, and set field language to interview language
survey.standard <- survey.standard %>%
  mutate(weight = ifelse(is.na(weight), 0.0, weight)) %>%
  mutate(trip_weight = ifelse(boardings > 0, weight / boardings, weight)) %>%
  mutate(field_language = interview_language)

save(survey.standard, file = F_OUTPUT_RDATA)
save(ancillary_df, file = F_ANCILLARY_OUTPUT_RDATA)
```

# DEBUG
```{r debug}
variables.MUN
colnames(survey.MUN)
 
for(variable in variables.MUN){
  if(variable %in% colnames(survey.MUN)){
    print(variable)
  }
  else{
    print(paste('donkey!!!',variable, sep = "---"))
  }
}

for(variable in colnames(survey.MUN.melt)){
  if(!(variable %in% colnames(survey.NAP.melt))){
    print(variable)
  }
}

```

