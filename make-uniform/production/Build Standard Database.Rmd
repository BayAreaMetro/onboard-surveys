---
title: "Build Standard Database"
author: "David Ory"
output:
  html_document:
    theme: cosmo
    toc: yes
runtime: shiny
---

## Administration

#### Purpose
Procedure to translate any number of on-board survey data sets into a single dataset with common variables and common responses.  This is a work-in-progress production version of the procedures.  See ``../mini-example`` and ``../small-example`` for working proto-types.  In this script, we put in place procedures to process surveys into a standard database.  See ``Extract Variables from Legacy Surveys.Rmd`` for procedures to extract variables from legacy surveys (i.e., those with SAS summary scripts). 

#### _ISSUES_
1.  Check a few freqs comparing the input data and the derived flat file

#### _TODO_
3.  Build full generalization with latest ETC -- how to handle geo-coding?  (write XY to disk for geo-coding and then re-join?)
4.  Add standard processing steps once data is in place
5.  Working solution -- build generic, process generic, bring in legacy SAS data (via CSV and R), extract any new variables from generic
6.  Add Tableau extracts
7.  Use generic for new operators
8.  Add data types before exporting to RData
9.  How to handle operators with mixed modes
10.  One branch for new variables from old data sets and one branch for new datasets

## Overhead

#### Libraries
```{r overhead}
library(knitr)
library(reshape2)
suppressMessages(library(dplyr))
library(stringr)
```

#### Knitr config
```{r config, include=FALSE}
knitr::opts_chunk$set(cache=TRUE)
```

## Prepare Dictionaries
```{r prepare-dictionary}
dictionary.all <- read.csv('Dictionary for Standard Database.csv', header = TRUE)

# Prepare seperate dictionaries for categorical and non-categorical variables
dictionary.non <- dictionary.all %>%
  filter(Generic_Response == 'NONCATEGORICAL') %>%
  select(Operator, Survey_Variable, Generic_Variable)

dictionary.cat <- dictionary.all %>%
  filter(Generic_Response != 'NONCATEGORICAL') %>%
  mutate(Survey_Response = as.character(Survey_Response))

```

## Operator specifics

### Caltrain Pilot
```{r operator-caltrain}
survey.CAL.key  <- 'Caltrain Pilot'
survey.CAL.year <- 2014

# Set survey tech by route if necessary in operator chunk
survey.CAL.tech <- 'commuter rail'


# Prepare operator-specific dictionary
dictionary.CAL <- dictionary.all %>%
  filter(Operator == survey.CAL.key)

variables.CAL <- as.character(factor(unique(unlist(dictionary.CAL$Survey_Variable, use.names = TRUE))))

# Read data and select variables of interest
survey.CAL <- read.csv('M:/Data/OnBoard/Data and Reports/Caltrain/As CSV/Caltrain_PilotTest_MainSurvey_Database_SubmittedOct16 NO POUND OR SINGLE QUOTE.csv', header = TRUE)
survey.CAL.select <- survey.CAL[ ,variables.CAL]

# Reshape the data
survey.CAL.melt <- melt(survey.CAL.select, id = 'ID')
survey.CAL.melt <- select(survey.CAL.melt, ID, Survey_Variable = variable, Survey_Response = value)
survey.CAL.melt <- mutate(survey.CAL.melt, Operator = survey.CAL.key)
survey.CAL.melt <- mutate(survey.CAL.melt, survey_year = survey.CAL.year)
survey.CAL.melt <- mutate(survey.CAL.melt, survey_tech = survey.CAL.tech)

# Clean up
remove(survey.CAL.key, survey.CAL.year, survey.CAL.tech, dictionary.CAL, variables.CAL, survey.CAL, survey.CAL.select)
```


## Combine across operators and flatten
```{r combine}
survey.combine <- rbind(survey.CAL.melt)

# Join the dictionary and prepare the categorical variables
survey.cat <- mutate(survey.combine, Survey_Response = as.character(Survey_Response))
survey.cat <- left_join(survey.cat, dictionary.cat, by = c("Operator", "Survey_Variable", "Survey_Response"))
survey.cat <- filter(survey.cat, !is.na(Generic_Variable))

# Join the dictionary and prepare the non-categorical variables
survey.non <- left_join(survey.combine, dictionary.non, by = c("Operator", "Survey_Variable"))
survey.non <- survey.non %>%
  filter(!is.na(Generic_Variable)) %>%
  mutate(Generic_Response = Survey_Response)

# Combine the categorical and non-categorical survey data and prepare to flatten
survey.cat.to_flat <- survey.cat %>%
  select(-Survey_Variable, -Survey_Response) %>%
  mutate(Generic_Response = as.factor(Generic_Response))

survey.non.to_flat <- survey.non %>%
  select(-Survey_Variable, -Survey_Response) %>%
  mutate(Generic_Response = as.factor(Generic_Response))

survey.to_flat <- rbind(survey.cat.to_flat, survey.non.to_flat)

# Put together and then take apart a unique ID when flattening
survey.to_flat <- survey.to_flat %>%
  mutate(Unique_ID = paste(ID, Operator, survey_year, sep = "---")) %>%
  select(-ID, -Operator, -survey_year)

survey.flat <- dcast(survey.to_flat, Unique_ID ~ Generic_Variable, value.var = 'Generic_Response')

survey.flat <- cbind(survey.flat, colsplit(survey.flat$Unique_ID, "---", c("ID", "Operator", "survey_year")))

# Add in survey technology
survey.tech <- survey.combine %>%
  group_by(ID, Operator, survey_year, survey_tech) %>%
  summarise(Count = n()) %>%
  select(-Count)

survey.flat <- left_join(survey.flat, survey.tech, by = c("ID", "Operator", "survey_year"))

remove(dictionary.cat, dictionary.non, survey.cat, survey.non, survey.cat.to_flat, survey.non.to_flat, survey.to_flat, survey.tech)
remove(survey.CAL.melt)

```

## Method Library for Standardization
```{r methods}
# Set Operator Name
Set_Operator_Name <- function(input_vector){
  
  input_df <- as.data.frame(input_vector)
  colnames(input_df) <- c("input_field")
  
  output_df <- input_df %>%
    mutate(output_field = ifelse(!is.na(input_field), "None", input_field)) %>%
    
    # BART, AMTRAK, and Caltrain may be named in route names, so do first, then overwrite
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("Amtrak")) > 0L, "AMTRAK", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("BART")) > 0L, "BART", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("Caltrain")) > 0L, "CALTRAIN", output_field)) %>%
    
    # Transit Agencies
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("AC Transit")) > 0L, "AC TRANSIT", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("AirBART")) > 0L, "MUNI", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("Capitol Corridor")) > 0L, "AMTRAK", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("County Connection")) > 0L,"COUNTY CONNECTION", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("Fairfield and")) > 0L,"FAIRFIELD-SUISUN",output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("Golden Gate Tran")) > 0L, "GOLDEN GATE TRANSIT", output_field)) %>%
     mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("Golden Gate Ferry")) > 0L, "GOLDEN GATE FERRY", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("Muni")) > 0L, "MUNI", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("SamTrans")) > 0L, "SAMTRANS",  output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("SF Bay Ferry")) > 0L, "SF BAY FERRY", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("Soltrans")) > 0L, "SOLTRANS", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("Tri Delta")) > 0L, "TRI-DELTA",  output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("WestCAT")) > 0L, "WESTCAT",  output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("VINE")) > 0L, "NAPA VINE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("VTA")) > 0L, "VTA", output_field)) %>% 
    
    # OTHER
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("Stanford")) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("Commuter shuttle")) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("Corinthian lines shuttle")) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("Caltrain- Shuttles Genentech")) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("Kaiser shuttle")) > 0L,  "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & str_count(input_field, ignore.case("San Jose airport shuttle")) > 0L,  "PRIVATE SHUTTLE", output_field))
  
  return(output_df$output_field)
}

# Set Technology
Set_Base_Technology <- function(input_vector){
  
  operator = c("AC TRANSIT",        "AIR BART",         "AMTRAK",              "BART",              "CALTRAIN",
               "COUNTY CONNECTION", "FAIRFIELD-SUISUN", "GOLDEN GATE TRANSIT", "GOLDEN GATE FERRY", "MUNI", 
               "NAPA VINE",         "SAMTRANS",         "SF BAY FERRY",        "SOLTRANS",          "TRI-DELTA", 
               "WESTCAT",           "VTA",              "OTHER",               "PRIVATE SHUTTLE")
  
  technology = c("local bus", "local bus", "commuter rail", "heavy rail", "commuter rail",
                 "local bus", "local bus", "express bus",   "ferry",      "local bus", 
                 "local bus", "local bus", "ferry",         "local bus",  "local bus",
                 "local bus", "local bus", "local bus",     "local bus")
  
  tech_df <- data.frame(operator, technology)
  
  
  input_df <- as.data.frame(input_vector)
  colnames(input_df) <- c("operator")
  input_df <- mutate(input_df, operator = as.character(operator))
  
  output_df <- left_join(input_df, tech_df, by = c("operator"))
  
  return(output_df$technology)
}

# Update Technology
Update_Technology <- function(input_vector){
  
  input_df <- as.data.frame(input_vector)
  colnames(input_df) <- c("input_field")
  
  output_df <- input_df %>%
    mutate(output_field = ifelse(!is.na(input_field), "No Update", input_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & 
                                   str_count(input_field, ignore.case("Muni")) > 0L &
                                   str_count(input_field, ignore.case("Light Rail")) > 0L, "light rail", output_field)) %>%
    mutate(output_field = ifelse(!is.na(input_field) & 
                                   str_count(input_field, ignore.case("VTA")) > 0L &
                                   str_count(input_field, ignore.case("Light Rail")) > 0L, "light rail", output_field))
  
  return(output_df$output_field)
}

```


## Build Standard variables
```{r standard-variables}
# Step 1:  Age-related transformations
# -------------------------------------------------------------------------------------

# Standardize year born
survey.standard <- survey.flat %>%
  mutate(year_born = as.numeric(year_born_four_digit)) %>%
  select(-year_born_four_digit)

# Manual fixes to year born
survey.standard <- survey.standard %>%
  mutate(year_born = ifelse(year_born == 1900, 2000, year_born)) %>%
  mutate(year_born = ifelse(year_born == 1901, 2001, year_born)) %>%
  mutate(year_born = ifelse(year_born == 3884, 1984, year_born))

table(survey.standard$year_born)

# Compute approximate respondent age 
survey.standard <- survey.standard %>%
  mutate(approximate_age = survey_year - year_born)

table(survey.standard$approximate_age)

# Step 2:  Trip- and tour-purpose-related transformations
# -------------------------------------------------------------------------------------

# Refine school purpose
survey.standard <- survey.standard %>%
  mutate(orig_purp = ifelse(orig_purp == "school", "high school", orig_purp)) %>%
  mutate(orig_purp = ifelse(orig_purp == "school" & approximate_age < 14, "grade_school", orig_purp))

# (Approximate) Tour purpose
survey.standard <- survey.standard %>%
  mutate(tour_purp = 'missing') %>%
  
  # workers -- simple
  mutate(tour_purp = ifelse(tour_purp == 'missing' & orig_purp == 'home' & dest_purp == 'work', 'work', tour_purp)) %>%
  mutate(tour_purp = ifelse(tour_purp == 'missing' & orig_purp == 'work' & dest_purp == 'home', 'work', tour_purp)) %>%
  
  # students -- simple
  mutate(tour_purp = ifelse(tour_purp == 'missing' & (orig_purp == 'grade school' | dest_purp == 'grade school'), 'grade school', tour_purp)) %>%
  mutate(tour_purp = ifelse(tour_purp == 'missing' & (orig_purp == 'high school'  | dest_purp == 'high school'),  'high  school', tour_purp)) %>%
  
  # non-working university students
  mutate(tour_purp = ifelse(tour_purp == 'missing' & worker_status == 'non-worker' & (orig_purp == 'college'  | dest_purp == 'college'),  'university', tour_purp)) %>%
  
  # non-workers, non-students, home-based travel
  mutate(tour_purp = ifelse(tour_purp == 'missing' & worker_status == 'non-worker' & student_status == 'non-student' & orig_purp == 'home', dest_purp, tour_purp)) %>%
  mutate(tour_purp = ifelse(tour_purp == 'missing' & worker_status == 'non-worker' & student_status == 'non-student' & dest_purp == 'home', orig_purp, tour_purp)) %>%
  mutate(tour_purp = ifelse(tour_purp == 'missing' & worker_status == 'non-worker' & student_status == 'non-student' & orig_purp == dest_purp, orig_purp, tour_purp)) %>%
  
  # non-workers, non-students, non-home-based (which we know from above implementation) escorting travel
  mutate(tour_purp = ifelse(tour_purp == 'missing' & worker_status == 'non-worker' & student_status == 'non-student' & (orig_purp == 'escorting' | dest_purp == 'escorting'), 'escorting', tour_purp)) %>%
  
  # university is present, but work is not, then university
  mutate(tour_purp = ifelse(tour_purp == 'missing' & at_work_prior_to_orig_purp == 'not at work before surveyed trip' & at_work_after_dest_purp == 'not at work after surveyed trip' & (orig_purp == 'college' | dest_purp == 'college'), 'university', tour_purp)) %>%
  
  # if work before trip and home after, assume work tour
  mutate(tour_purp = ifelse(tour_purp == 'missing' & at_work_prior_to_orig_purp == 'at work before surveyed trip' & dest_purp == 'home', 'work', tour_purp)) %>%
  
  # if work after trip and home before, assume work tour
   mutate(tour_purp = ifelse(tour_purp == 'missing' & at_work_after_dest_purp == 'at work after surveyed trip' & orig_purp == 'home', 'work', tour_purp)) %>%
  
  # if non-worker, school before trip and home after, over 18, university tour
   mutate(tour_purp = ifelse(tour_purp == 'missing' & worker_status == 'non-worker' & at_school_prior_to_orig_purp == 'at school before surveyed trip' & approximate_age > 18 & dest_purp == 'home', 'university', tour_purp)) %>%
  
  # if non-worker, school after trip and home before, over 18, university tour
   mutate(tour_purp = ifelse(tour_purp == 'missing' & worker_status == 'non-worker' & at_school_after_dest_purp == 'at school after surveyed trip' & approximate_age > 18 & orig_purp == 'home', 'college', tour_purp)) %>%
  
    # if non-worker, school before trip and home after, 14 to 18, high school tour
   mutate(tour_purp = ifelse(tour_purp == 'missing' & worker_status == 'non-worker' & at_school_prior_to_orig_purp == 'at school before surveyed trip' & approximate_age <= 18 & approximate_age >= 14 & dest_purp == 'home', 'high school', tour_purp)) %>%
  
  # if non-worker, school after trip and home before, 14 to 18, high school tour
   mutate(tour_purp = ifelse(tour_purp == 'missing' & worker_status == 'non-worker' & at_school_after_dest_purp == 'at school after surveyed trip' & approximate_age <= 18 & approximate_age >= 14 & orig_purp == 'home', 'high school', tour_purp)) %>%
  
  # if no work before or after, but work is a leg, assume a work tour
  mutate(tour_purp = ifelse(tour_purp == 'missing' & at_work_prior_to_orig_purp == 'not at work before surveyed trip' & at_work_after_dest_purp == 'not at work after surveyed trip' & (orig_purp == 'work' | dest_purp == 'work'), 'work', tour_purp)) %>%
  
  # at work tours
  mutate(tour_purp = ifelse(tour_purp == 'missing' & at_work_prior_to_orig_purp == 'at work before surveyed trip' & dest_purp == 'work', 'at work', tour_purp)) %>%
  mutate(tour_purp = ifelse(tour_purp == 'missing' & at_work_after_dest_purp == 'at work after surveyed trip' & orig_purp == 'work', 'at work', tour_purp)) %>%
  
  # if still left and work before or after the trip, assume work tour
  mutate(tour_purp = ifelse(tour_purp == 'missing' & at_work_after_dest_purp == 'at work after surveyed trip' & at_work_prior_to_orig_purp == 'at work before surveyed trip', 'work', tour_purp)) %>%
  
  # if still left and home is one end, chose the other as the purpose
  mutate(tour_purp = ifelse(tour_purp == 'missing' & orig_purp == 'home', dest_purp, tour_purp)) %>%
  mutate(tour_purp = ifelse(tour_purp == 'missing' & dest_purp == 'home', orig_purp, tour_purp)) %>%
  
  # if still left, pick the orig_purp
  mutate(tour_purp = ifelse(tour_purp == 'missing', orig_purp, tour_purp))
           
table(survey.standard$tour_purp)


# Step 3:  Update Key locations
# -------------------------------------------------------------------------------------

# Home
survey.standard <- survey.standard %>%
  mutate(home_lat = ifelse(orig_purp == 'home' & is.na(home_lat), orig_lat, home_lat)) %>%
  mutate(home_lon = ifelse(orig_purp == 'home' & is.na(home_lon), orig_lon, home_lon)) %>%
  mutate(home_lat = ifelse(dest_purp == 'home' & is.na(home_lat), dest_lat, home_lat)) %>%
  mutate(home_lon = ifelse(dest_purp == 'home' & is.na(home_lon), dest_lon, home_lon)) %>%
  
# Work
  mutate(workplace_lat = ifelse(orig_purp == 'work' & is.na(workplace_lat), orig_lat, workplace_lat)) %>%
  mutate(workplace_lon = ifelse(orig_purp == 'work' & is.na(workplace_lon), orig_lon, workplace_lon)) %>%
  mutate(workplace_lat = ifelse(dest_purp == 'work' & is.na(workplace_lat), dest_lat, workplace_lat)) %>%
  mutate(workplace_lon = ifelse(dest_purp == 'work' & is.na(workplace_lon), dest_lon, workplace_lon)) %>%
  
# School
  mutate(school_lat = ifelse((orig_purp == 'grade school' | orig_purp == 'high school' | orig_purp == 'college') & is.na(school_lat), orig_lat, school_lat)) %>%
  mutate(school_lon = ifelse((orig_purp == 'grade school' | orig_purp == 'high school' | orig_purp == 'college') & is.na(school_lon), orig_lon, school_lon)) %>%
  mutate(school_lat = ifelse((dest_purp == 'grade school' | dest_purp == 'high school' | dest_purp == 'college') & is.na(school_lat), dest_lat, school_lat)) %>%
  mutate(school_lon = ifelse((dest_purp == 'grade school' | dest_purp == 'high school' | dest_purp == 'college') & is.na(school_lon), dest_lon, school_lon)) 
  

# Step 4:  Automobile Sufficiency
# -------------------------------------------------------------------------------------

# Transform vehicles and workers to standard scale
survey.standard <- survey.standard %>%
  mutate(vehicles = ifelse(vehicles == 'other', vehicles_additional_info, vehicles)) %>%
  mutate(workers  = ifelse(workers  == 'other', workers_additional_info,  workers ))

table(survey.standard$vehicles)
table(survey.standard$workers)

vehicles.dictionary <- data.frame(vehicles = c('zero', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine', 'ten', 'eleven', 'twelve', 'four or more'), vehicle_numeric_cat = c(0, 1, 2, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4))

workers.dictionary <- data.frame(workers = c('zero', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine', 'ten', 'eleven', 'twelve', 'thirteen', 'fourteen', 'fifteen', 'six or more'), worker_numeric_cat = c(0, 1, 2, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4))

survey.standard <- left_join(survey.standard, vehicles.dictionary, by = c("vehicles"))
survey.standard <- left_join(survey.standard, workers.dictionary, by = c("workers"))

survey.standard <- survey.standard %>%
  mutate(auto_suff = ifelse(vehicle_numeric_cat == 0, 'zero autos', 'missing')) %>%
  mutate(auto_suff = ifelse(vehicle_numeric_cat > 0 & worker_numeric_cat > 0  & worker_numeric_cat >  vehicle_numeric_cat, 'auto negotiating', auto_suff)) %>%
  mutate(auto_suff = ifelse(vehicle_numeric_cat > 0 & worker_numeric_cat >= 0 & worker_numeric_cat <= vehicle_numeric_cat, 'auto sufficient', auto_suff))

table(survey.standard$auto_suff)


# Step 5:  Operator and Technology sequence
# -------------------------------------------------------------------------------------

# Set operator for each of six legs (three before, three after)
first_before <- as.data.frame(Set_Operator_Name(survey.standard$first_route_before_survey_board))
colnames(first_before) <- c("first_before_operator")

second_before <- as.data.frame(Set_Operator_Name(survey.standard$second_route_before_survey_board))
colnames(second_before) <- c("second_before_operator")

third_before <- as.data.frame(Set_Operator_Name(survey.standard$third_route_before_survey_board))
colnames(third_before) <- c("third_before_operator")

first_after <- as.data.frame(Set_Operator_Name(survey.standard$first_route_after_survey_alight))
colnames(first_after) <- c("first_after_operator")

second_after <- as.data.frame(Set_Operator_Name(survey.standard$second_route_after_survey_alight))
colnames(second_after) <- c("second_after_operator")

third_after <- as.data.frame(Set_Operator_Name(survey.standard$third_route_after_survey_alight))
colnames(third_after) <- c("third_after_operator")

survey.standard <- cbind(survey.standard, first_before, second_before, third_before, first_after, second_after, third_after)

# Set the technology for each of the six legs
first_before <- as.data.frame(Set_Base_Technology(survey.standard$first_before_operator))
colnames(first_before) <- c("first_before_technology")

second_before <- as.data.frame(Set_Base_Technology(survey.standard$second_before_operator))
colnames(second_before) <- c("second_before_technology")

third_before <- as.data.frame(Set_Base_Technology(survey.standard$third_before_operator))
colnames(third_before) <- c("third_before_technology")

first_after <- as.data.frame(Set_Base_Technology(survey.standard$first_after_operator))
colnames(first_after) <- c("first_after_technology")

second_after <- as.data.frame(Set_Base_Technology(survey.standard$second_after_operator))
colnames(second_after) <- c("second_after_technology")

third_after <- as.data.frame(Set_Base_Technology(survey.standard$third_after_operator))
colnames(third_after) <- c("third_after_technology")

survey.standard <- cbind(survey.standard, first_before, second_before, third_before, first_after, second_after, third_after)

# Update the technology
first_before <- as.data.frame(Update_Technology(survey.standard$first_route_before_survey_board))
colnames(first_before) <- c("first_before_update_tech")

second_before <- as.data.frame(Update_Technology(survey.standard$second_route_before_survey_board))
colnames(second_before) <- c("second_before_update_tech")

third_before <- as.data.frame(Update_Technology(survey.standard$third_route_before_survey_board))
colnames(third_before) <- c("third_before_update_tech")

first_after <- as.data.frame(Update_Technology(survey.standard$first_route_after_survey_alight))
colnames(first_after) <- c("first_after_update_tech")

second_after <- as.data.frame(Update_Technology(survey.standard$second_route_after_survey_alight))
colnames(second_after) <- c("second_after_update_tech")

third_after <- as.data.frame(Update_Technology(survey.standard$third_route_after_survey_alight))
colnames(third_after) <- c("third_after_update_tech")

survey.standard <- cbind(survey.standard, first_before, second_before, third_before, first_after, second_after, third_after)
  
table(survey.standard$first_before_technology)

survey.standard <- survey.standard %>%
  mutate(first_before_technology  = ifelse(first_before_update_tech  != "No Update", as.character(first_before_update_tech),  as.character(first_before_technology))) %>%
  mutate(second_before_technology = ifelse(second_before_update_tech != "No Update", as.character(second_before_update_tech), as.character(second_before_technology))) %>%
  mutate(third_before_technology  = ifelse(third_before_update_tech  != "No Update", as.character(third_before_update_tech),  as.character(third_before_technology))) %>%
  mutate(first_after_technology   = ifelse(first_after_update_tech   != "No Update", as.character(first_after_update_tech),  as.character(first_after_technology))) %>%
  mutate(second_after_technology  = ifelse(second_after_update_tech  != "No Update", as.character(second_after_update_tech),  as.character(second_after_technology))) %>%
  mutate(third_after_technology   = ifelse(third_after_update_tech   != "No Update", as.character(third_after_update_tech),   as.character(third_after_technology)))

table(survey.standard$first_before_technology)


# Step 6:  Travel Model One path details
# -------------------------------------------------------------------------------------

# Transfer to and from
survey.standard <- survey.standard %>%
  mutate(transfer_from = as.character(first_before_operator)) %>%
  mutate(transfer_from = ifelse(second_before_operator != 'None', as.character(second_before_operator), transfer_from)) %>%
  mutate(transfer_from = ifelse(third_before_operator  != 'None', as.character(third_before_operator),  transfer_from)) %>%
  mutate(transfer_to = as.character(first_after_operator))

# First boarding and last alighting technology
survey.standard <- survey.standard %>%
  mutate(first_transit_tech = as.character(survey_tech)) %>%
  mutate(first_transit_tech = ifelse(!is.na(first_before_technology), first_before_technology, first_transit_tech)) %>%
  mutate(last_transit_tech  = as.character(survey_tech)) %>%
  mutate(last_transit_tech = ifelse(!is.na(first_after_technology),  first_after_technology,  last_transit_tech)) %>%
  mutate(last_transit_tech = ifelse(!is.na(second_after_technology), second_after_technology, last_transit_tech)) %>%
  mutate(last_transit_tech = ifelse(!is.na(third_after_technology),  third_after_technology,  last_transit_tech))

table(survey.standard$transfer_from)
table(survey.standard$transfer_to)
table(survey.standard$survey_tech)
table(survey.standard$first_transit_tech)
table(survey.standard$last_transit_tech)

# Travel Model One path
survey.standard <- survey.standard %>%
  # Access
  mutate(path_access = 'X') %>%
  mutate(path_access = ifelse(access_mode == 'walk', 'W', path_access)) %>%
  mutate(path_access = ifelse(access_mode == 'pnr' , 'D', path_access)) %>%
  mutate(path_access = ifelse(access_mode == 'knr' , 'D', path_access)) %>%
  mutate(path_access = ifelse(access_mode == 'bike', 'D', path_access)) %>%
  # Egress
  mutate(path_egress = 'X') %>%
  mutate(path_egress = ifelse(egress_mode == 'walk', 'W', path_egress)) %>%
  mutate(path_egress = ifelse(egress_mode == 'pnr' , 'D', path_egress)) %>%
  mutate(path_egress = ifelse(egress_mode == 'knr' , 'D', path_egress)) %>%
  mutate(path_egress = ifelse(egress_mode == 'bike', 'D', path_egress)) %>%
  # Line haul
  mutate(path_line_haul = 'XXX') %>%
  mutate(path_line_haul = ifelse( (first_before_technology  == 'commuter rail' | 
                                   second_before_technology == 'commuter rail' |
                                   third_before_technology  == 'commuter rail' |
                                   first_after_technology   == 'commuter rail' |
                                   second_after_technology  == 'commuter rail' |
                                   third_after_technology   == 'commuter rail' |
                                   survey_tech              == 'commuter rail'), 'COM', path_line_haul)) %>%
  mutate(path_line_haul = ifelse( path_line_haul == 'XXX' &
                                  (first_before_technology  == 'heavy rail' | 
                                   second_before_technology == 'heavy rail' |
                                   third_before_technology  == 'heavy rail' |
                                   first_after_technology   == 'heavy rail' |
                                   second_after_technology  == 'heavy rail' |
                                   third_after_technology   == 'heavy rail' |
                                   survey_tech              == 'heavy rail'),  'HVY', path_line_haul)) %>%
  mutate(path_line_haul = ifelse( path_line_haul == 'XXX' &
                                  (first_before_technology  == 'express bus' | 
                                   second_before_technology == 'express bus' |
                                   third_before_technology  == 'express bus' |
                                   first_after_technology   == 'express bus' |
                                   second_after_technology  == 'express bus' |
                                   third_after_technology   == 'express bus' |
                                   survey_tech              == 'express bus'), 'EXP', path_line_haul)) %>%
  mutate(path_line_haul = ifelse( path_line_haul == 'XXX' &
                                  (first_before_technology  == 'ferry' | 
                                   second_before_technology == 'ferry' |
                                   third_before_technology  == 'ferry' |
                                   first_after_technology   == 'ferry' |
                                   second_after_technology  == 'ferry' |
                                   third_after_technology   == 'ferry' |
                                   survey_tech              == 'ferry'), 'LRF', path_line_haul)) %>%
  mutate(path_line_haul = ifelse( path_line_haul == 'XXX' &
                                  (first_before_technology  == 'light rail' | 
                                   second_before_technology == 'light rail' |
                                   third_before_technology  == 'light rail' |
                                   first_after_technology   == 'light rail' |
                                   second_after_technology  == 'light rail' |
                                   third_after_technology   == 'light rail' |
                                   survey_tech              == 'light rail'),  'LRF', path_line_haul)) %>%
  mutate(path_line_haul = ifelse( path_line_haul == 'XXX', 'LOC', path_line_haul)) %>%
  mutate(path_label = paste(path_access, path_line_haul, path_egress, sep = "-"))

table(survey.standard$path_label)
           
# Boardings
survey.standard <- survey.standard %>%
  mutate(boardings = 1L) %>%
  mutate(boardings = ifelse(!is.na(first_before_technology),  boardings + 1, boardings)) %>%
  mutate(boardings = ifelse(!is.na(second_before_technology), boardings + 1, boardings)) %>%
  mutate(boardings = ifelse(!is.na(third_before_technology),  boardings + 1, boardings)) %>%
  mutate(boardings = ifelse(!is.na(first_after_technology),   boardings + 1, boardings)) %>%
  mutate(boardings = ifelse(!is.na(second_after_technology),  boardings + 1, boardings)) %>%
  mutate(boardings = ifelse(!is.na(third_after_technology),   boardings + 1, boardings))

table(survey.standard$boardings)

survey.standard <- survey.standard %>%
  mutate(survey_boardings = 1L + as.numeric(number_transfers_orig_board) + as.numeric(number_transfers_alight_dest))

table(survey.standard$boardings, survey.standard$survey_boardings)

# Step 7:  Standardize Demographics
# -------------------------------------------------------------------------------------
  
# START HERE

```

### Geocode XY to Travel Model Geographies

### Add Data types

## Bring in Legacy SAS Data set

## Extract Tableau summaries

## Write working set to RData

## Prepare and Write public data set to CSV





