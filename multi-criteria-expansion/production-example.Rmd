---
title: "Production-Example"
author: "David Ory"
html_document:
    toc: true
    theme: cosmo
runtime: shiny
---

## Administration

#### Status
early days, porting from small-example

#### Purpose
Demonstrate multi-criteria transit on-board survey expansion using R tools via a production (i.e.,  practice-ready) example using real data.  Here, we use two surveys performed on Tri-Delta.  The first survey was a simple on-off count performed for ~70 percent of the riders; we assume this data represents the population ridership characteristics.  The second survey is a personal interview survey containing typical questions; this survey has already been expanded to external data, which will give us some results to compare to.

#### Overhead
```{r}
library(knitr)
library(stringr)
library(optimx)
library(reshape2)
suppressMessages(library(dplyr))
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=TRUE)
```

## Data Preparation
#### Remote data locations
```{r data-reads}
input_dir  <- "M:/Data/OnBoard/Data and Reports/Tri Delta/As CSV/"
output_dir <- "D:/files/My Box Files/Share Data/multi-criteria-expansion/"

input.tablet <- read.table(file = paste(input_dir,"ONBOARD NO POUND OR SINGLE QUOTE.csv", sep = ""), header = TRUE, sep = ",", stringsAsFactors = FALSE)

input.onoff  <- read.table(file = paste(input_dir, "ON2OFF NO POUND OR SINGLE QUOTE.csv", sep = ""), header = TRUE, sep = ",", stringsAsFactors = FALSE)

input.sequence <- read.table(file = paste(input_dir, "RTD_ROUTE_STOPS_ALL_MODES_MAR_2 NO POUND OR SINGLE QUOTE.csv", sep = ""), header = TRUE, sep = ",", stringsAsFactors = FALSE)

```

#### Standardize data
```{r prepare-datasets}
# Survey data, align variables
survey <- input.tablet %>%
  select(tablet_id = ID, 
         route_dir = ROUTE.CODE, 
         direction = DIRECTION, 
         time_period = TIME_PERIOD,
         board_id = BOARDING_LOCATION_STOPID, 
         board_shp = BOARDING_LOCATION_STOPID_SHP, 
         alight_id = ALIGHTING_LOCATION_STOPID, 
         alight_shp = ALIGHTING_LOCATION_STOPID_SHP, 
         weight = UNLINKED_WGHT_FCTR) %>%
  mutate(route = as.numeric(str_sub(route_dir, 1, 3))) %>%
  filter(route != 392) %>%
  filter(route != 393) %>%
  filter(route != 394) %>%
  filter(route != 395) %>%
  mutate(time_period = ifelse(time_period == "LATE PM", "EVENING", time_period))

# Use on/off survey as a proxy for detailed observed data
observed <- input.onoff %>%
  select(onoff_id = ETC_ID, 
         route = ROUTE_ON, 
         direction = DIRECTION_ON, 
         time_period = TIME.PERIOD, 
         board_id = BOARDING_STOPID_, 
         board_shp = BOARDING_STOPID_SHP, 
         board_seq = BOARDING_STOPSEQUENCE, 
         alight_id = ALIGHTING_STOPID_, 
         alight_shp = ALIGHTING_STOPID_SHP, 
         alight_seq = ALIGHTING_STOPSEQUENCE, 
         match_confidence = matchConfidence) %>%
  mutate(time_period = ifelse(time_period == "AM1", "EARLY AM", time_period)) %>%
  mutate(time_period = ifelse(time_period == "AM2", "AM PEAK",  time_period)) %>%
  mutate(time_period = ifelse(time_period == "MID", "MIDDAY",   time_period)) %>%
  mutate(time_period = ifelse(time_period == "PM1", "PM PEAK",  time_period)) %>%
  mutate(time_period = ifelse(time_period == "PM2", "EVENING",  time_period)) %>%
  filter(match_confidence == "100%")

stops <- input.sequence %>%
  select(operator = CPT_AGENCY, 
         route = SCH_ROUTED, 
         direction = RTD_PATTER, 
         stop_seq = SCH_STOPPO, 
         stop_shp = CPT_STOPPO) %>%
  filter(operator == '3D') %>%
  select(-operator)

````

#### Add route break points
```{r route-breaks}
# Determine maximum number of routes by direction
segment_breaks <- observed %>%
  group_by(route, direction) %>%
  summarise(max_board_seq = max(board_seq), max_alight_seq = max(alight_seq))

# TODO: make this more elegant

# Create the segment breaks
segment_breaks <- segment_breaks %>%
  mutate(break_2_1 = round((max_board_seq + max_alight_seq) / 4)) %>%
  mutate(break_3_1 = round((max_board_seq + max_alight_seq) / 6)) %>%
  mutate(break_3_2 = break_3_1 * 2) %>%
  mutate(break_4_1 = round((max_board_seq + max_alight_seq) / 8)) %>%
  mutate(break_4_2 = break_4_1 * 2) %>%
  mutate(break_4_3 = break_4_1 * 3)

# Place the observed data into the segment breaks
observed <- left_join(observed, segment_breaks, by = c("route", "direction"))

observed <- observed %>%
  # Two segments
  mutate(board_seg_2  = ifelse(board_seq  < break_2_1, 1, 2)) %>%
  mutate(alight_seg_2 = ifelse(alight_seq < break_2_1, 1, 2)) %>%
  # Three segments
  mutate(board_seg_3  = ifelse(board_seq  <  break_3_1, 1, 2)) %>%
  mutate(board_seg_3  = ifelse(board_seq  >= break_3_2, 3, board_seg_3)) %>%
  mutate(alight_seg_3 = ifelse(alight_seq <  break_3_1, 1, 2)) %>%
  mutate(alight_seg_3 = ifelse(alight_seq >= break_3_2, 3, alight_seg_3)) %>%
  # Four segments
  mutate(board_seg_4  = ifelse(board_seq  <  break_4_1, 1, 2)) %>%
  mutate(board_seg_4  = ifelse(board_seq  >= break_4_1 & board_seq < break_4_2, 2, board_seg_4)) %>%
  mutate(board_seg_4  = ifelse(board_seq  >= break_4_2 & board_seq < break_4_3, 3, board_seg_4)) %>%
  mutate(board_seg_4  = ifelse(board_seq  >= break_4_3, 4, board_seg_4)) %>%
  mutate(alight_seg_4 = ifelse(alight_seq <  break_4_1, 1, 2)) %>%
  mutate(alight_seg_4 = ifelse(alight_seq >= break_4_1 & alight_seq < break_4_2, 2, alight_seg_4)) %>%
  mutate(alight_seg_4 = ifelse(alight_seq >= break_4_2 & alight_seq < break_4_3, 3, alight_seg_4)) %>%
  mutate(alight_seg_4 = ifelse(alight_seq >= break_4_3, 4, alight_seg_4)) %>%
  # Remove excess variables
  select(-break_2_1, -break_3_1, -break_3_2, -break_4_1, -break_4_2, -break_4_3, -max_board_seq, -max_alight_seq)

# Place the survey data into the segment breaks
stops_board <- stops %>%
  select(route, direction, board_seq = stop_seq, board_shp = stop_shp)

stops_alight <- stops %>%
  select(route, direction, alight_seq = stop_seq, alight_shp = stop_shp)

survey <- left_join(survey, stops_board, by = c("route",  "direction", "board_shp")) 
survey <- left_join(survey, stops_alight, by = c("route", "direction", "alight_shp"))
survey <- left_join(survey, segment_breaks, by = c("route", "direction"))

survey <- survey %>%
  # Two segments
  mutate(board_seg_2  = ifelse(board_seq  < break_2_1, 1, 2)) %>%
  mutate(alight_seg_2 = ifelse(alight_seq < break_2_1, 1, 2)) %>%
  # Three segments
  mutate(board_seg_3  = ifelse(board_seq  <  break_3_1, 1, 2)) %>%
  mutate(board_seg_3  = ifelse(board_seq  >= break_3_2, 3, board_seg_3)) %>%
  mutate(alight_seg_3 = ifelse(alight_seq <  break_3_1, 1, 2)) %>%
  mutate(alight_seg_3 = ifelse(alight_seq >= break_3_2, 3, alight_seg_3)) %>%
  # Four segments
  mutate(board_seg_4  = ifelse(board_seq  <  break_4_1, 1, 2)) %>%
  mutate(board_seg_4  = ifelse(board_seq  >= break_4_1 & board_seq < break_4_2, 2, board_seg_4)) %>%
  mutate(board_seg_4  = ifelse(board_seq  >= break_4_2 & board_seq < break_4_3, 3, board_seg_4)) %>%
  mutate(board_seg_4  = ifelse(board_seq  >= break_4_3, 4, board_seg_4)) %>%
  mutate(alight_seg_4 = ifelse(alight_seq <  break_4_1, 1, 2)) %>%
  mutate(alight_seg_4 = ifelse(alight_seq >= break_4_1 & alight_seq < break_4_2, 2, alight_seg_4)) %>%
  mutate(alight_seg_4 = ifelse(alight_seq >= break_4_2 & alight_seq < break_4_3, 3, alight_seg_4)) %>%
  mutate(alight_seg_4 = ifelse(alight_seq >= break_4_3, 4, alight_seg_4)) %>%
  # Remove excess variables
  select(-break_2_1, -break_3_1, -break_3_2, -break_4_1, -break_4_2, -break_4_3, -max_board_seq, -max_alight_seq)

# TODO: what to do with non-matches (NA right now)

```


## Optimization Function
#### Inputs
1. `x` - a vector of length M representing each of the unique survey weights that need to be calculated
2. `obs_target_v` - a vector of length N containing each expansion target
3. `import_v` - a vector of length N containing the importance weight for each expansion target
4. `inc_mtx` - a matrix of dimensions M x N containing a dummy variable denoting the relevance of each unique survey weight to each expansion target
```{r optimization-function}
optimization_function <- function(x, obs_target_v, import_v, inc_mtx) {
  
  # Compute estimated targets 
  est_target_v <- x %*% inc_mtx
  
  # Compute importance-weighted errors, which is the objective function
  error_df <- data.frame(obs_target_v, est_target_v, import_v)
  error_df <- error_df %>%
    mutate(error <- import_v * abs(est_target_v - obs_target_v))
  
  # Return errors
  return(sum(error_df$error))

}

```

## Production-Example
Expand the Tri-Delta survey by (i) route, direction, and time-of-day; (ii) system-wide ridership; (iii) route, direction, and boarding sequence category (4 categories); (iv) route, direction, and alighting sequence category (4 categories); and, (v) route, direction, boarding sequence category, and alighting sequence category (3 categories).  

#### Prepare the observed targets vector
```{r observed-targets}
# Target Set 1: Route, direction, and time-of-day
observed_targets_1 <- observed %>%
  group_by(route, direction, time_period) %>%
  summarise(target_count = n()) %>%
  ungroup() %>%
  mutate(target_id = paste(route, "---", direction, "---", time_period, sep = "")) %>%
  select(target_id, target_count)

# Target Set 2: System-wide ridership (match sum of existing survey weights)
observed_targets_2 <- data.frame(target_id = c("all_routes"), target_count = c(9849))

# Target Set 3: Route, direction, 4-category boarding segment
observed_targets_3 <- observed %>%
  group_by(route, direction, board_seg_4) %>%
  summarise(target_count = n()) %>%
  ungroup() %>%
  mutate(target_id = paste(route, "---", direction, "---board-", board_seg_4, sep = "")) %>%
  select(target_id, target_count)

# Target Set 4: Route, direction, 4-category alighting segment
observed_targets_4 <- observed %>%
  group_by(route, direction, alight_seg_4) %>%
  summarise(target_count = n()) %>%
  ungroup() %>%
  mutate(target_id = paste(route, "---", direction, "---alight-", alight_seg_4, sep = "")) %>%
  select(target_id, target_count)

# Target Set 5: Route, direction, 3-category boarding, 3-category alighting
observed_targets_5 <- observed %>%
  group_by(route, direction, board_seg_3, alight_seg_3) %>%
  summarise(target_count = n()) %>%
  ungroup() %>%
  mutate(target_id = paste(route, "---", direction, "---board-", board_seg_3, "---alight-", alight_seg_3, sep = "")) %>%
  select(target_id, target_count)

# Combine the targets
observed_targets <- rbind(observed_targets_1, observed_targets_2, observed_targets_3, observed_targets_4, observed_targets_5)
observed_targets_vector <- observed_targets$target_count

```

#### Build the importance weight vector
```{r importance-weights}
weight_route_direction_time = 1.0
weight_all_routes = 20.0
weight_route_direction_board  = 2.0
weight_route_direction_alight = 2.0
weight_route_direction_board_alight = 3.0

importance_weights <- observed_targets %>%
  # Default weight
  mutate(weight = weight_route_direction_time) %>%
  # All routes
  mutate(weight = ifelse(str_detect(target_id, "all_routes"), weight_all_routes, weight)) %>%
  # Boardings
  mutate(weight = ifelse(str_detect(target_id, "board")  & !str_detect(target_id, "alight"), weight_route_direction_board, weight)) %>%
  # Alightings
  mutate(weight = ifelse(!str_detect(target_id, "board") & str_detect(target_id, "alight"), weight_route_direction_alight, weight)) %>%
  # Boardings + Alightings
  mutate(weight = ifelse(str_detect(target_id, "board")  & str_detect(target_id, "alight"), weight_route_direction_board_alight, weight))

importance_weights_vector <- importance_weights$weight

```

#### Build the incidence matrix
```{r incidence-matrix}

# START HERE
# For each group of targets, (a) create a square matrix with target_id (perhaps add a category variable to the observed_targets data frame), (b) fill the square matrix with diagonal ones; (c) compute the appropriate target_id in the survey; (d) join the dummies matrix to the survey; (e) do this in the same order as when you create the targets; (f) cbind; (g) push to matrix


  
```

#### Execute the optimization and extract results
```{r run-optimization}


```

#### Join optimization results to survey data
```{r join-results}


```

#### Explore the difference in the two sets of weights
```{r weight-diff}

```

## Data writes
#### Write the example extracted input files to disk for others' reference
```{r data-writes}

```

