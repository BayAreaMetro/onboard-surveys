---
title: "Production-Example"
author: "David Ory"
html_document:
    toc: true
    theme: cosmo
runtime: shiny
---

## Administration

#### Status
early days, porting from small-example

#### Purpose
Demonstrate multi-criteria transit on-board survey expansion using R tools via a production (i.e.,  practice-ready) example using real data.  Here, we use two surveys performed on Tri-Delta.  The first survey was a simple on-off count performed for ~70 percent of the riders; we assume this data represents the population ridership characteristics.  The second survey is a personal interview survey containing typical questions; this survey has already been expanded to external data, which will give us some results to compare to.

#### Overhead
```{r}
library(knitr)
library(stringr)
library(optimx)
library(reshape2)
suppressMessages(library(dplyr))
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=TRUE)
```

## Data Preparation
#### Remote data locations
```{r data-reads}
input_dir  <- "M:/Data/OnBoard/Data and Reports/Tri Delta/As CSV/"
output_dir <- "D:/files/My Box Files/Share Data/multi-criteria-expansion/"

input.tablet <- read.table(file = paste(input_dir,"ONBOARD NO POUND OR SINGLE QUOTE.csv", sep = ""), header = TRUE, sep = ",", stringsAsFactors = FALSE)

input.onoff  <- read.table(file = paste(input_dir, "ON2OFF NO POUND OR SINGLE QUOTE.csv", sep = ""), header = TRUE, sep = ",", stringsAsFactors = FALSE)

input.sequence <- read.table(file = paste(input_dir, "RTD_ROUTE_STOPS_ALL_MODES_MAR_2 NO POUND OR SINGLE QUOTE.csv", sep = ""), header = TRUE, sep = ",", stringsAsFactors = FALSE)

```

#### Standardize data
```{r prepare-datasets}
# Survey data, align variables
survey <- input.tablet %>%
  select(tablet_id = ID, 
         route_dir = ROUTE.CODE, 
         direction = DIRECTION, 
         time_period = TIME_PERIOD,
         board_id = BOARDING_LOCATION_STOPID, 
         board_shp = BOARDING_LOCATION_STOPID_SHP, 
         alight_id = ALIGHTING_LOCATION_STOPID, 
         alight_shp = ALIGHTING_LOCATION_STOPID_SHP, 
         weight = UNLINKED_WGHT_FCTR) %>%
  mutate(route = as.numeric(str_sub(route_dir, 1, 3))) %>%
  filter(route != 392) %>%
  filter(route != 393) %>%
  filter(route != 394) %>%
  filter(route != 395) %>%
  mutate(time_period = ifelse(time_period == "LATE PM", "EVENING", time_period))

# Use on/off survey as a proxy for detailed observed data
observed <- input.onoff %>%
  select(onoff_id = ETC_ID, 
         route = ROUTE_ON, 
         direction = DIRECTION_ON, 
         time_period = TIME.PERIOD, 
         board_id = BOARDING_STOPID_, 
         board_shp = BOARDING_STOPID_SHP, 
         board_seq = BOARDING_STOPSEQUENCE, 
         alight_id = ALIGHTING_STOPID_, 
         alight_shp = ALIGHTING_STOPID_SHP, 
         alight_seq = ALIGHTING_STOPSEQUENCE, 
         match_confidence = matchConfidence) %>%
  mutate(time_period = ifelse(time_period == "AM1", "EARLY AM", time_period)) %>%
  mutate(time_period = ifelse(time_period == "AM2", "AM PEAK",  time_period)) %>%
  mutate(time_period = ifelse(time_period == "MID", "MIDDAY",   time_period)) %>%
  mutate(time_period = ifelse(time_period == "PM1", "PM PEAK",  time_period)) %>%
  mutate(time_period = ifelse(time_period == "PM2", "EVENING",  time_period))

stops <- input.stops %>%
  select(operator = CPT_AGENCY, 
         route = SCH_ROUTED, 
         direction = RTD_PATTER, 
         stop_seq = SCH_STOPPO, 
         stop_shp = CPT_STOPPO) %>%
  filter(operator == '3D') %>%
  select(-operator)

````

#### Add route break points
```{r route-breaks}


```


## Optimization Function
#### Inputs
1. `x` - a vector of length M representing each of the unique survey weights that need to be calculated
2. `obs_target_v` - a vector of length N containing each expansion target
3. `import_v` - a vector of length N containing the importance weight for each expansion target
4. `inc_mtx` - a matrix of dimensions M x N containing a dummy variable denoting the relevance of each unique survey weight to each expansion target
```{r optimization-function}
optimization_function <- function(x, obs_target_v, import_v, inc_mtx) {
  
  # Compute estimated targets 
  est_target_v <- x %*% inc_mtx
  
  # Compute importance-weighted errors, which is the objective function
  error_df <- data.frame(obs_target_v, est_target_v, import_v)
  error_df <- error_df %>%
    mutate(error <- import_v * abs(est_target_v - obs_target_v))
  
  # Return errors
  return(sum(error_df$error))

}

```

## Production-Example
Expand the Tri-Delta survey by (i) route, direction, and time-of-day; (ii) system-wide ridership; (iii) route, direction, and boarding sequence category (Y categories); (iv) route, direction, and alighting sequence category (Y categories); and, (v) route, direction, boarding sequence category, and alighting sequence category (X categories).  

#### Prepare the observed targets vector
```{r observed-targets}

```

#### Build the importance weight vector
```{r importance-weights}

```

#### Build the incidence matrix
```{r incidence-matrix}
  
```

#### Execute the optimization and extract results
```{r run-optimization}


```

#### Join optimization results to survey data
```{r join-results}


```

#### Explore the difference in the two sets of weights
```{r weight-diff}

```

## Data writes
#### Write the example extracted input files to disk for others' reference
```{r data-writes}

```

