---
title: "Production-Example"
author: "David Ory"
html_document:
    toc: true
    theme: cosmo
runtime: shiny
---

## Administration

#### Status
decent start to the method-library approach

#### TODO
0. Finish Example 1, add Example 2 (standard approach), then Example 3

1. Can we make the optimization faster?  Other methods?

2. Vary weights, targets, etc, to make sure response is as expected.

3. Catch inconsistent input errors

#### Purpose
Demonstrate multi-criteria transit on-board survey expansion using R tools via a production (i.e.,  practice-ready) example using real data.  Here, we use two surveys performed on Tri-Delta.  The first survey was a simple on-off count performed for ~70 percent of the riders.  The second is a personal interview survey of ~5 percent of the riders. Here we use external files to define our targets.

## Key Input Files
#### Observed Target Counts
The `observed-target-counts` input database must have the following fields:
(i) `target_id` - integer, a unique integer for the target;
(ii) `target_count` - float, the target value for the target (i.e., the weights will be adjusted to match the targets);
(iii) `importance_weight` - float, the importance weight for the target;
(iv) `target_category` - string, a label for each group of targets;
(v) {survey variable names} - any number of columns that define the targets composition using the survey variable names, e.g., route, direction, time_period.  Each string MUST correspond to a variable in the survey data. 

#### Observed Target Definitions
The `observed-target-definitions` input database must have the following fields:
(i) `target_category` - string, a label for each group of targets;
(ii) `survey_variable` - string, a label for the variables that comprise the target, with each variable being entered on a separate row in the database.  Each string MUST correspond to a variable in the survey data, with the exception of `all_routes` which denotes a target that is applied to all records in the survey.

#### Survey Data
The `survey` data must have the variables (as columns) defined in the `observed-target-counts` and `observed-target-definitions` files.

## Examples
#### Example 1: Five categories of targets

Please see `build-production-example-inputs.Rmd` for the creation of these files.  

Narrative details are as follows:

1.  Five categories of targets are defined, as follows:
(a)  Category A: single, system-wide target;
(b)  Category B: by route, direction, and time of day;
(c)  Category C: by route, direction, and four-category boarding segment;
(d)  Category D: by route, direction, and four-category alighting segment;
(e)  Category E: by route, direction, three-category boarding segment, and three-category alighting segment.

Note that if a single, system-wide target is used, it must be in Category A (i.e., be listed first).

2.  Target categories A and B are drawn for the personal interview survey; categories C, D, and E are drawn from the on-off survey.

## Example 2
TODO: add

## Procedure

#### Overhead
```{r}
source("method-library.R")
library(knitr)
suppressMessages(library(dplyr))
library(ggplot2)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=TRUE)
```

#### Parameters
```{r parameters}
record_weight_lower_bound = 1.0
record_weight_upper_bound = 30.0
```

## Data Preparation
#### Remote data locations
```{r data-reads}
#remote_dir <- "D:/files/My Box Files/Share Data/multi-criteria-expansion/"
remote_dir <- "~DavidWork/Documents/multi-criteria-expansion-inputs/"
```

## Example 1
#### Example 1 Inputs
```{r example-01-inputs}
F_INPUT_SURVEY  <- paste(remote_dir, "production-example-survey.Rdata", sep = "")
F_INPUT_DEFNS   <- paste(remote_dir, "observed-target-counts.Rdata", sep = "")
F_INPUT_TARGETS <- paste(remote_dir, "observed-target-definitions.Rdata", sep = "")

load(F_INPUT_SURVEY)
load(F_INPUT_DEFNS)
load(F_INPUT_TARGETS)
```

#### Example 1 Optimization
```{r execute-optimization}
survey_with_results <- execute_optimization(observed_targets, 
                                            observed_targets_defn,
                                            survey,
                                            record_weight_lower_bound,
                                            record_weight_upper_bound) 
```

# START HERE
# Example 1 Summaries
